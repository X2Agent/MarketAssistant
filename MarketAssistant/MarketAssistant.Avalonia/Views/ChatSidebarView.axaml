<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.Avalonia.ViewModels"
             xmlns:converts="using:MarketAssistant.Avalonia.Converts"
             xmlns:controls="using:MarketAssistant.Avalonia.Controls"
             mc:Ignorable="d" d:DesignWidth="480" d:DesignHeight="800"
             x:Class="MarketAssistant.Avalonia.Views.ChatSidebarView"
             x:DataType="vm:ChatSidebarViewModel"
             x:Name="Root">

    <UserControl.Resources>
        <converts:InvertBoolConverter x:Key="InvertBoolConverter"/>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*,Auto" Background="{DynamicResource BackgroundBrush}">
        
        <!-- 标题栏 -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="*,Auto"
              Background="{DynamicResource CardBackgroundBrush}"
              Height="56">
            <TextBlock Grid.Column="0" 
                       Text="智能对话" 
                       FontSize="18"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"
                       Margin="16,0" />
            
            <Button Grid.Column="1"
                    Content="✕"
                    FontSize="18"
                    Background="Transparent"
                    Width="36"
                    Height="36"
                    CornerRadius="18"
                    Margin="8"
                    Command="{Binding #Root.CloseCommand}"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center"/>
        </Grid>

        <!-- 对话消息列表 -->
        <ListBox Grid.Row="1" 
                 x:Name="ChatListBox"
                 ItemsSource="{Binding ChatMessages}"
                 Background="Transparent"
                 SelectionMode="Single"
                 Margin="8,0">
            
            <ListBox.Styles>
                <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="12,4"/>
                    <Setter Property="Margin" Value="0,2"/>
                </Style>
            </ListBox.Styles>

            <ListBox.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatMessageAdapter">
                    <StackPanel Spacing="4">
                        <!-- 时间戳 -->
                        <TextBlock Text="{Binding FormattedTime}" 
                                   FontSize="10" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   HorizontalAlignment="Center" />
                        
                        <!-- 用户消息 -->
                        <Border Padding="12,8"
                                Background="{DynamicResource PrimaryBrush}"
                                HorizontalAlignment="Right"
                                MaxWidth="360"
                                CornerRadius="18,18,4,18"
                                IsVisible="{Binding IsUser}">
                            <StackPanel Spacing="2">
                                <TextBlock Text="{Binding Sender}" 
                                           FontSize="11"
                                           FontWeight="Bold"
                                           Foreground="White" />
                                <TextBlock Text="{Binding Content}" 
                                          FontSize="14"
                                          TextWrapping="Wrap"
                                          Foreground="White" />
                            </StackPanel>
                        </Border>
                        
                        <!-- AI/系统消息 -->
                        <Border Padding="12,8"
                                Background="{DynamicResource CardBackgroundBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                HorizontalAlignment="Left"
                                MaxWidth="360"
                                CornerRadius="18,18,18,4"
                                IsVisible="{Binding IsUser, Converter={StaticResource InvertBoolConverter}}">
                            <StackPanel Spacing="4">
                                <TextBlock Text="{Binding Sender}" 
                                           FontSize="11"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource PrimaryBrush}" />
                                
                                <!-- 状态指示器 -->
                                <Grid ColumnDefinitions="Auto,*" 
                                      ColumnSpacing="4"
                                      IsVisible="{Binding Status, Converter={StaticResource InvertBoolConverter}}">
                                    <ProgressBar Grid.Column="0" 
                                                IsIndeterminate="True"
                                                Width="12" Height="12" />
                                    <TextBlock Grid.Column="1" 
                                               Text="正在思考..." 
                                               FontSize="10"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                                
                                <!-- 内容区域 -->
                                <controls:RichTextBlock Text="{Binding Content}" 
                                                       IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- 输入区域 -->
        <Grid Grid.Row="2" 
              ColumnDefinitions="*,Auto"
              Margin="12"
              ColumnSpacing="12">
            
            <!-- 输入框 -->
            <TextBox Grid.Column="0"
                     x:Name="MessageEntry"
                     Text="{Binding UserInput}"
                     Watermark="询问关于股票分析的问题..."
                     FontSize="14"
                     MinHeight="48"
                     IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertBoolConverter}}"
                     VerticalContentAlignment="Center" />

            <!-- 发送按钮 -->
            <Button Grid.Column="1"
                    Content="{Binding SendButtonText}"
                    Command="{Binding SendMessageCommand}"
                    Background="{DynamicResource PrimaryBrush}"
                    Foreground="White"
                    FontSize="16"
                    FontWeight="Bold"
                    Width="52"
                    Height="52"
                    CornerRadius="26"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center"/>
        </Grid>
    </Grid>
</UserControl>

