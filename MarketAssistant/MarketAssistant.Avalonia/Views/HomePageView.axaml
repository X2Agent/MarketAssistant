<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.Avalonia.ViewModels"
             xmlns:controls="using:MarketAssistant.Avalonia.Controls"
             xmlns:svg="clr-namespace:Avalonia.Svg.Skia;assembly=Svg.Controls.Skia.Avalonia"
             xmlns:telegrams="using:MarketAssistant.Applications.Telegrams"
             xmlns:stocks="using:MarketAssistant.Applications.Stocks.Models"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="MarketAssistant.Avalonia.Views.HomePageView"
             x:DataType="vm:HomePageViewModel">

    <UserControl.Resources>
        <ResourceDictionary>
            <!-- TODO: 添加PriceChangeColorConverter -->
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- 搜索结果列表样式 -->
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="12"/>
        </Style>
        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBackgroundBrush}"/>
        </Style>
        
        <!-- 热门股票卡片悬停效果 -->
        <Style Selector="Border.hot-stock-card">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Border.hot-stock-card:pointerover">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBackgroundBrush}"/>
        </Style>
        <Style Selector="Border.hot-stock-card:pointerover Panel#FavoriteButton">
            <Setter Property="IsVisible" Value="True"/>
        </Style>
        
        <!-- 新闻卡片悬停效果 -->
        <Style Selector="Border.news-card">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Border.news-card:pointerover">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBackgroundBrush}"/>
        </Style>
        
        <!-- 最近查看卡片悬停效果 -->
        <Style Selector="Border.recent-stock-card">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Border.recent-stock-card:pointerover">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBackgroundBrush}"/>
        </Style>
        <Style Selector="Border.recent-stock-card:pointerover Panel#RecentFavoriteButton">
            <Setter Property="IsVisible" Value="True"/>
        </Style>
    </UserControl.Styles>

    <Grid Margin="16" RowDefinitions="Auto,*">
        
        <!-- 顶部搜索区域 -->
        <controls:CardView Grid.Row="0" Margin="0,0,0,12">
            <Grid>
                <AutoCompleteBox Watermark="输入股票代码或名称"
                                 MinimumPrefixLength="1"
                                 ItemsSource="{Binding Search.SearchResults}"
                                 SelectedItem="{Binding Search.SelectStockCommand}"
                                 FilterMode="None"
                                 Text="{Binding Search.SearchQuery, Mode=TwoWay}"
                                 Background="Transparent"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 FontSize="16"
                                 Padding="12,8">
                    <AutoCompleteBox.ItemTemplate>
                        <DataTemplate x:DataType="stocks:StockItem">
                            <Grid ColumnDefinitions="*,Auto" Margin="4">
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding Name}" 
                                               FontWeight="SemiBold"
                                               FontSize="14"/>
                                    <TextBlock Text="{Binding Code}" 
                                               FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               Margin="0,2,0,0"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </AutoCompleteBox.ItemTemplate>
                </AutoCompleteBox>
            </Grid>
        </controls:CardView>

        <!-- 三列布局 -->
        <Grid Grid.Row="1" 
              ColumnDefinitions="2*,3*,1*">
            
            <!-- 左侧：7*24小时新闻快讯 -->
            <controls:CardView Grid.Column="0" Margin="0,0,8,0">
                <controls:CardView.Header>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0" 
                                   Text="7*24小时快讯" 
                                   FontSize="16" 
                               FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="1"
                                   Text="{Binding News.TelegraphRefreshCountdown}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0"/>
                    </Grid>
                </controls:CardView.Header>
                
                <ScrollViewer>
                    <ItemsControl ItemsSource="{Binding News.Telegraphs}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Spacing="8"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="telegrams:Telegram">
                                <Border Classes="news-card">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackPanel Grid.Column="0" Spacing="4">
                                            <TextBlock Text="{Binding Title}"
                               FontSize="14" 
                                                       FontWeight="SemiBold"
                                                       TextWrapping="Wrap"/>
                                            <TextBlock Text="{Binding Content}"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       TextWrapping="Wrap"
                                                       MaxLines="3"/>
                                            
                                            <!-- 关联股票标签 -->
                                            <ItemsControl ItemsSource="{Binding Stocks}" Margin="0,4,0,0">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate x:DataType="x:String">
                                                        <Border BorderBrush="{DynamicResource BorderBrush}"
                                                                BorderThickness="1"
                                                                CornerRadius="4"
                                                                Padding="4,2"
                                                                Margin="0,0,4,4">
                                                            <TextBlock Text="{Binding .}"
                                                                       FontSize="12"
                                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                </StackPanel>
                                        
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Time}"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   VerticalAlignment="Center"
                                                   Margin="8,0,0,0"/>
                                    </Grid>
            </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </controls:CardView>
            
            <!-- 中间：热门推荐 -->
            <controls:CardView Grid.Column="1" Margin="0,0,8,0">
                <controls:CardView.Header>
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0"
                                   Text="热门推荐"
                                   FontSize="16" 
                                   FontWeight="SemiBold"/>
                        <svg:Svg Grid.Column="1"
                                 Path="/Assets/Images/trending_icon.svg"
                                 Width="20"
                                 Height="20"
                                 VerticalAlignment="Center"/>
                    </Grid>
                </controls:CardView.Header>
                
                <ScrollViewer>
                    <ItemsControl ItemsSource="{Binding HotStocks.HotStocks}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="2" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="stocks:HotStock">
                                <Border Classes="hot-stock-card" Margin="4">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <!-- 左侧信息 -->
                                        <StackPanel Grid.Column="0" Spacing="4">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Text="{Binding Market}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                <TextBlock Text="{Binding Code}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            
                                            <TextBlock Text="{Binding Name}"
                                                       FontSize="14"
                                                       FontWeight="Bold"/>
                                            
                                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                                <TextBlock Text="{Binding CurrentPrice}"
                                                           FontSize="16"
                                                           FontWeight="Bold"/>
                                                <TextBlock Text="{Binding ChangePercentage}"
                                                           FontSize="14"
                                                           Foreground="{DynamicResource SuccessBrush}"/>
                                            </StackPanel>
                    </StackPanel>
                                        
                                        <!-- 右侧热度与收藏 -->
                                        <StackPanel Grid.Column="1" 
                                                    Spacing="4" 
                                                    HorizontalAlignment="Right" 
                                                    VerticalAlignment="Center">
                                            <TextBlock Text="热度"
                                                       FontSize="10"
                                                       HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <TextBlock Text="{Binding HeatIndex}"
                                                       FontSize="14"
                                                       FontWeight="Bold"
                                                       HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource PrimaryBrush}"/>
                                            
                                            <Panel Name="FavoriteButton" IsVisible="False">
                                                <Button Background="Transparent"
                                                        Command="{Binding $parent[UserControl].((vm:HomePageViewModel)DataContext).HotStocks.AddToFavoriteCommand}"
                                                        CommandParameter="{Binding .}"
                                                        Width="24"
                                                        Height="24"
                                                        Padding="0">
                                                    <svg:Svg Path="/Assets/Images/tab_favorites.svg"
                                                             Width="16"
                                                             Height="16"/>
                                                </Button>
                                            </Panel>
                    </StackPanel>
                                    </Grid>
                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </controls:CardView>
            
            <!-- 右侧：最近查看 -->
            <controls:CardView Grid.Column="2" Header="最近查看">
                <ScrollViewer>
                    <Grid>
                        <ItemsControl ItemsSource="{Binding RecentStocks.RecentStocks}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Spacing="8"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="stocks:StockItem">
                                    <Border Classes="recent-stock-card">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0" 
                                                        Spacing="4" 
                                                        VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Name}"
                                                           FontSize="14"
                                                           FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Code}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            
                                            <!-- 收藏按钮 -->
                                            <Panel Grid.Column="1" 
                                                   Name="RecentFavoriteButton" 
                                                   IsVisible="False"
                                                   VerticalAlignment="Center">
                                                <Button Background="Transparent"
                                                        Command="{Binding $parent[UserControl].((vm:HomePageViewModel)DataContext).RecentStocks.AddToFavoriteCommand}"
                                                        CommandParameter="{Binding .}"
                                                        Width="24"
                                                        Height="24"
                                                        Padding="0">
                                                    <svg:Svg Path="/Assets/Images/tab_favorites.svg"
                                                             Width="16"
                                                             Height="16"/>
                                                </Button>
                                            </Panel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <!-- 空视图提示 -->
                        <StackPanel IsVisible="{Binding !RecentStocks.RecentStocks.Count}"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Spacing="12">
                            <svg:Svg Path="/Assets/Images/empty_data.svg"
                                     Width="64"
                                     Height="64"
                                     Opacity="0.6"/>
                            <TextBlock Text="暂无查看记录"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="搜索或浏览热门股票以添加记录"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </controls:CardView>
        </Grid>
            </Grid>
</UserControl>