<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MarketAssistant.ViewModels"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="MarketAssistant.Views.ChatSidebarView"
             x:DataType="viewmodels:ChatSidebarViewModel"
             x:Name="Root">

    <ContentView.Resources>
        <ResourceDictionary>
            <!-- ç”¨æˆ·æ¶ˆæ¯æ ·å¼ - å‚è€ƒ agent-ui è®¾è®¡ -->
            <Style x:Key="UserMessageStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}" />
                <Setter Property="Stroke" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="12,8" />
                <Setter Property="Margin" Value="16,4,8,4" />
            </Style>
            
            <!-- AIæ¶ˆæ¯æ ·å¼ - å‚è€ƒ agent-ui è®¾è®¡ -->
            <Style x:Key="AiMessageStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}" />
                <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="Padding" Value="12,8" />
                <Setter Property="Margin" Value="8,4,16,4" />
            </Style>
            
            <!-- ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ - æ–°å¢žï¼Œç”¨äºŽæ˜¾ç¤ºå·¥å…·è°ƒç”¨ç­‰ -->
            <Style x:Key="SystemMessageStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Warning}, Dark={StaticResource Warning}}" />
                <Setter Property="Stroke" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="8,4" />
                <Setter Property="Margin" Value="12,2,12,2" />
                <Setter Property="Opacity" Value="0.9" />
            </Style>
            
            <!-- æ¶ˆæ¯æ–‡æœ¬æ ·å¼ -->
            <Style x:Key="MessageTextStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="LineBreakMode" Value="WordWrap" />
                <Setter Property="LineHeight" Value="1.4" />
            </Style>
            
            <!-- ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬æ ·å¼ -->
            <Style x:Key="UserMessageTextStyle" TargetType="Label" BasedOn="{StaticResource MessageTextStyle}">
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
            </Style>
            
            <!-- AIæ¶ˆæ¯æ–‡æœ¬æ ·å¼ -->
            <Style x:Key="AiMessageTextStyle" TargetType="Label" BasedOn="{StaticResource MessageTextStyle}">
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}" />
            </Style>
            
            <!-- ç³»ç»Ÿæ¶ˆæ¯æ–‡æœ¬æ ·å¼ -->
            <Style x:Key="SystemMessageTextStyle" TargetType="Label" BasedOn="{StaticResource MessageTextStyle}">
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="FontAttributes" Value="Italic" />
            </Style>
            
            <!-- æ¶ˆæ¯å¤´éƒ¨æ ·å¼ -->
            <Style x:Key="MessageHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Opacity" Value="0.7" />
            </Style>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid RowDefinitions="Auto,*,Auto" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}">
        
        <!-- æ ‡é¢˜æ  -->
        <Border Grid.Row="0" 
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray950}}"
                Padding="{StaticResource CardPadding}">
            <Grid ColumnDefinitions="*,Auto">
                <Label Grid.Column="0" 
                       Text="æ™ºèƒ½å¯¹è¯" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}"
                       VerticalOptions="Center" />
                
                <Button Grid.Column="1"
                        Text="âœ•"
                        FontSize="16"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                        Command="{Binding CloseCommand, Source={x:Reference Root}}"
                        Padding="8,4"
                        WidthRequest="32"
                        HeightRequest="32" />
            </Grid>
        </Border>

        <!-- å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ - å‚è€ƒ agent-ui çš„æ¶ˆæ¯å±•ç¤º -->
        <ScrollView Grid.Row="1" x:Name="ChatScrollView" Padding="8,0">
            <CollectionView ItemsSource="{Binding ChatMessages}" 
                            BackgroundColor="Transparent"
                            SelectionMode="None"
                            ItemSizingStrategy="MeasureAllItems">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:ChatMessage">
                        <Grid Padding="0,2" RowDefinitions="Auto,Auto">
                            
                            <!-- æ¶ˆæ¯æ—¶é—´æˆ³ - å±…ä¸­æ˜¾ç¤º -->
                            <Label Grid.Row="0" 
                                   Text="{Binding FormattedTime}" 
                                   FontSize="10" 
                                   TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                   HorizontalOptions="Center"
                                   Margin="0,4,0,2"
                                   IsVisible="True" />
                            
                            <Grid Grid.Row="1">
                                <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                                <Border IsVisible="{Binding IsUser}" 
                                        Style="{StaticResource UserMessageStyle}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16,4,16,16" />
                                    </Border.StrokeShape>
                                    <StackLayout Spacing="2">
                                        <Label Text="æ‚¨" 
                                               Style="{StaticResource MessageHeaderStyle}"
                                               TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}"
                                               HorizontalOptions="End" />
                                        <Label Text="{Binding Content}" 
                                               Style="{StaticResource UserMessageTextStyle}" />
                                        <!-- æ¶ˆæ¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                                        <Grid HorizontalOptions="End" ColumnDefinitions="Auto,Auto" ColumnSpacing="4">
                                            <Label Grid.Column="0" 
                                                   Text="â—" 
                                                   FontSize="8" 
                                                   TextColor="LightGreen"
                                                   IsVisible="{Binding Status, Converter={toolkit:CompareConverter}, ConverterParameter={x:Static viewmodels:MessageStatus.Sent}}"
                                                   VerticalOptions="Center" />
                                            <Label Grid.Column="0" 
                                                   Text="â—" 
                                                   FontSize="8" 
                                                   TextColor="Orange"
                                                   IsVisible="{Binding Status, Converter={toolkit:CompareConverter}, ConverterParameter={x:Static viewmodels:MessageStatus.Sending}}"
                                                   VerticalOptions="Center" />
                                            <Label Grid.Column="0" 
                                                   Text="â—" 
                                                   FontSize="8" 
                                                   TextColor="Red"
                                                   IsVisible="{Binding Status, Converter={toolkit:CompareConverter}, ConverterParameter={x:Static viewmodels:MessageStatus.Failed}}"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </StackLayout>
                                </Border>
                                
                                <!-- AIæ¶ˆæ¯ -->
                                <Border IsVisible="{Binding IsUser, Converter={toolkit:InvertedBoolConverter}}" 
                                        Style="{StaticResource AiMessageStyle}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="4,16,16,16" />
                                    </Border.StrokeShape>
                                    <StackLayout Spacing="4">
                                        <!-- AI æ ‡è¯†å’Œåç§° -->
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                                            <Ellipse Grid.Column="0" 
                                                     Fill="{StaticResource Primary}" 
                                                     WidthRequest="16" 
                                                     HeightRequest="16"
                                                     VerticalOptions="Center" />
                                            <Label Grid.Column="1" 
                                                   Text="{Binding Sender}" 
                                                   Style="{StaticResource MessageHeaderStyle}"
                                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                                   IsVisible="{Binding Sender, Converter={toolkit:IsStringNotNullOrEmptyConverter}}"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                        
                                        <!-- æ¶ˆæ¯å†…å®¹ -->
                                        <Label Text="{Binding Content}" 
                                               Style="{StaticResource AiMessageTextStyle}" />
                                        
                                        <!-- å·¥å…·è°ƒç”¨æŒ‡ç¤ºå™¨ï¼ˆé¢„ç•™ï¼‰ -->
                                        <Border IsVisible="False"
                                                Style="{StaticResource SystemMessageStyle}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="8" />
                                            </Border.StrokeShape>
                                            <Label Text="ðŸ”§ è°ƒç”¨å·¥å…·: è‚¡ç¥¨åˆ†æž" 
                                                   Style="{StaticResource SystemMessageTextStyle}" />
                                        </Border>
                                    </StackLayout>
                                </Border>
                            </Grid>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <!-- è¾“å…¥åŒºåŸŸ - å‚è€ƒ agent-ui çš„çŽ°ä»£åŒ–è¾“å…¥è®¾è®¡ -->
        <Border Grid.Row="2" 
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                StrokeThickness="1"
                Padding="12">
            <Grid RowDefinitions="Auto" RowSpacing="8">
                
                <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Border Grid.Column="0" 
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray600}}"
                            Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                            StrokeThickness="1"
                            Padding="12,10">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>
                        <Entry x:Name="MessageEntry"
                               Text="{Binding UserInput}"
                               Placeholder="è¯¢é—®å…³äºŽè‚¡ç¥¨åˆ†æžçš„é—®é¢˜..."
                               BackgroundColor="Transparent"
                               FontSize="14"
                               ReturnType="Send"
                               ReturnCommand="{Binding SendMessageCommand}"
                               PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                    </Border>

                    <!-- å‘é€æŒ‰é’® -->
                    <Border Grid.Column="1"
                            BackgroundColor="{StaticResource Primary}"
                            WidthRequest="40"
                            HeightRequest="40">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>
                        <Button Text="âž¤"
                                Command="{Binding SendMessageCommand}"
                                BackgroundColor="Transparent"
                                TextColor="White"
                                FontSize="16"
                                FontAttributes="Bold"
                                IsEnabled="{Binding UserInput, Converter={toolkit:IsStringNotNullOrEmptyConverter}}" />
                    </Border>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</ContentView>
