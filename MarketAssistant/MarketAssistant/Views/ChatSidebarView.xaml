<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MarketAssistant.ViewModels"
             x:DataType="viewmodels:ChatSidebarViewModel"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="MarketAssistant.Views.ChatSidebarView"
             x:Name="Root">

    <ContentView.Resources>
        <ResourceDictionary>
            <!-- 用户消息样式 - 参考 agent-ui 设计 -->
            <Style x:Key="UserMessageStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}" />
                <Setter Property="Stroke" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="12,8" />
                <Setter Property="Margin" Value="16,4,8,4" />
            </Style>
            
            <!-- AI消息样式 - 参考 agent-ui 设计 -->
            <Style x:Key="AiMessageStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F8F9FA, Dark=#374151}" />
                <Setter Property="Stroke" Value="{AppThemeBinding Light=#E5E7EB, Dark=#4B5563}" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="Padding" Value="12,8" />
                <Setter Property="Margin" Value="8,4,16,4" />
            </Style>
            
            <!-- 系统消息样式 - 新增，用于显示工具调用等 -->
            <Style x:Key="SystemMessageStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Warning}, Dark={StaticResource Warning}}" />
                <Setter Property="Stroke" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="Padding" Value="8,4" />
                <Setter Property="Margin" Value="12,2,12,2" />
                <Setter Property="Opacity" Value="0.9" />
            </Style>
            
            <!-- 消息文本样式 -->
            <Style x:Key="MessageTextStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="LineBreakMode" Value="WordWrap" />
                <Setter Property="LineHeight" Value="1.4" />
            </Style>
            
            <!-- 用户消息文本样式 -->
            <Style x:Key="UserMessageTextStyle" TargetType="Label" BasedOn="{StaticResource MessageTextStyle}">
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
            </Style>
            
            <!-- AI消息文本样式 -->
            <Style x:Key="AiMessageTextStyle" TargetType="Label" BasedOn="{StaticResource MessageTextStyle}">
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}" />
            </Style>
            
            <!-- 系统消息文本样式 -->
            <Style x:Key="SystemMessageTextStyle" TargetType="Label" BasedOn="{StaticResource MessageTextStyle}">
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource White}}" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="FontAttributes" Value="Italic" />
            </Style>
            
            <!-- 消息头部样式 -->
            <Style x:Key="MessageHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Opacity" Value="0.7" />
            </Style>
            
            <!-- 圆角Entry样式 -->
            <Style x:Key="RoundedEntryStyle" TargetType="Entry">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F9FAFB, Dark=#374151}" />
                <Setter Property="Visual" Value="Material" />
            </Style>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid RowDefinitions="Auto,*,Auto" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}">
        
        <!-- 标题栏 -->
        <Border Grid.Row="0" 
                BackgroundColor="{AppThemeBinding Light={StaticResource CardBackgroundLight}, Dark={StaticResource CardBackgroundDark}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                Padding="16,12">
            <Grid ColumnDefinitions="*,Auto">
                <Label Grid.Column="0" 
                       Text="智能对话" 
                       Style="{StaticResource LargeLabelStyle}"
                       VerticalOptions="Center" />
                
                <Button Grid.Column="1"
                        Text="✕"
                        FontSize="18"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                        Command="{Binding Source={x:Reference Root}, Path=CloseCommand}"
                        Padding="8"
                        WidthRequest="36"
                        HeightRequest="36"
                        CornerRadius="18"
                        BorderWidth="0" />
            </Grid>
        </Border>

        <!-- 对话消息列表 - 参考 agent-ui 的消息展示 -->
        <CollectionView Grid.Row="1" 
                        x:Name="ChatCollectionView"
                        ItemsSource="{Binding ChatMessages}" 
                        BackgroundColor="Transparent"
                        SelectionMode="None"
                        ItemSizingStrategy="MeasureFirstItem"
                        Margin="8,0"
                        VerticalOptions="FillAndExpand"
                        VerticalScrollBarVisibility="Default">
                <CollectionView.EmptyView>
                    <StackLayout Padding="16" VerticalOptions="Center">
                        <Label Text="💬" 
                               FontSize="48" 
                               HorizontalOptions="Center" 
                               Margin="0,0,0,16" />
                        <Label Text="暂无对话消息" 
                               FontSize="16" 
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                               HorizontalOptions="Center" 
                               HorizontalTextAlignment="Center" />
                        <Label Text="开始对话或进行股票分析后，消息将显示在这里" 
                               FontSize="14" 
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                               HorizontalOptions="Center" 
                               HorizontalTextAlignment="Center"
                               Margin="0,8,0,0" />
                    </StackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:ChatMessageAdapter">
                        <!-- 智能对齐的消息模板 -->
                        <Grid Padding="8,4" Margin="4,2" RowDefinitions="Auto,Auto">
                            <!-- 时间戳 -->
                            <Label Grid.Row="0" 
                                   Text="{Binding FormattedTime}" 
                                   FontSize="10" 
                                   TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                   HorizontalOptions="Center"
                                   Margin="0,0,0,4" />
                            
                            <!-- 用户消息 - 右对齐 -->
                            <Border Grid.Row="1" 
                                    Padding="12,8"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                    Stroke="Transparent"
                                    StrokeThickness="0"
                                    HorizontalOptions="End"
                                    MaximumWidthRequest="280"
                                    IsVisible="{Binding IsUser}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="18,18,4,18" />
                                </Border.StrokeShape>
                                <Grid RowDefinitions="Auto,Auto">
                                    <!-- 发送者 -->
                                    <Label Grid.Row="0" 
                                           Text="{Binding Sender}" 
                                           FontSize="11" 
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           Margin="0,0,0,2" />
                                    <!-- 内容 -->
                                    <Label Grid.Row="1" 
                                           Text="{Binding Content}" 
                                           FontSize="14" 
                                           TextColor="White"
                                           LineBreakMode="WordWrap" />
                                </Grid>
                            </Border>
                            
                            <!-- 系统/AI消息 - 左对齐 -->
                            <Border Grid.Row="1" 
                                    Padding="12,8"
                                    BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#374151}"
                                    Stroke="{AppThemeBinding Light=#E5E7EB, Dark=#4B5563}"
                                    StrokeThickness="1"
                                    HorizontalOptions="Start"
                                    MaximumWidthRequest="280"
                                    IsVisible="{Binding IsUser, Converter={toolkit:InvertedBoolConverter}}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="18,18,18,4" />
                                </Border.StrokeShape>
                                <Grid RowDefinitions="Auto,Auto,Auto">
                                    <!-- 发送者 -->
                                    <Label Grid.Row="0" 
                                           Text="{Binding Sender}" 
                                           FontSize="11" 
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                           Margin="0,0,0,2" />
                                    
                                    <!-- 状态指示器 -->
                                    <StackLayout Grid.Row="1" 
                                                 Orientation="Horizontal" 
                                                 IsVisible="{Binding Status, Converter={toolkit:EnumToBoolConverter}, ConverterParameter={x:Static viewmodels:MessageStatus.Sending}}"
                                                 Margin="0,0,0,4">
                                        <ActivityIndicator IsRunning="True"
                                                         Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                                                         WidthRequest="12"
                                                         HeightRequest="12" />
                                        <Label Text="正在思考..."
                                               FontSize="10"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                               Margin="4,0,0,0" />
                                    </StackLayout>
                                    
                                    <!-- 内容 -->
                                    <StackLayout Grid.Row="2" Orientation="Horizontal">
                                        <Label Text="{Binding Content}" 
                                               FontSize="14" 
                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}"
                                               LineBreakMode="WordWrap"
                                               HorizontalOptions="FillAndExpand" />
                                        
                                        <!-- 失败状态图标 -->
                                        <Label Text="⚠️"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light={StaticResource Error}, Dark={StaticResource Error}}"
                                               IsVisible="{Binding Status, Converter={toolkit:EnumToBoolConverter}, ConverterParameter={x:Static viewmodels:MessageStatus.Failed}}"
                                               VerticalOptions="Start"
                                               Margin="4,0,0,0" />
                                    </StackLayout>
                                </Grid>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- 输入区域 - 重新设计的布局 -->
        <StackLayout Grid.Row="2" 
                     Orientation="Horizontal" 
                     Padding="16,12,16,16"
                     BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1F2937}"
                     Spacing="12"
                     VerticalOptions="End">
            
            <!-- 输入框 - 纯Entry实现 -->
            <Entry x:Name="MessageEntry"
                   Text="{Binding UserInput}"
                   Placeholder="询问关于股票分析的问题..."
                   BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#374151}"
                   FontSize="14"
                   ReturnType="Send"
                   ReturnCommand="{Binding SendMessageCommand}"
                   PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}"
                   VerticalOptions="Center"
                   HorizontalOptions="FillAndExpand"
                   HeightRequest="48"
                   Margin="16,0,16,0"
                   IsEnabled="{Binding IsProcessing, Converter={toolkit:InvertedBoolConverter}}" />

            <!-- 发送/取消按钮 -->
            <Button Text="{Binding SendButtonText}"
                    Command="{Binding SendMessageCommand}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Primary}}"
                    TextColor="White"
                    FontSize="18"
                    FontAttributes="Bold"
                    WidthRequest="48"
                    HeightRequest="48"
                    CornerRadius="24"
                    BorderWidth="0"
                    VerticalOptions="Center"
                    IsEnabled="True" />
        </StackLayout>
    </Grid>
</ContentView>
