<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:MarketAssistant.Controls"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:MarketAssistant.ViewModels"
             xmlns:agents="clr-namespace:MarketAssistant.Agents"
             x:Class="MarketAssistant.Pages.StockSelectionPage"
             x:DataType="viewmodels:StockSelectionViewModel">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- é¡µé¢ç‰¹æœ‰èµ„æº - ä¿ç•™é€‰è‚¡é¡µé¢ç‰¹æœ‰çš„èµ„æºå®šä¹‰ -->
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView Padding="{StaticResource PagePadding}">
        <VerticalStackLayout Spacing="{StaticResource SmallSpacing}">
            
            <!-- é¡µé¢æ ‡é¢˜ -->
            <Label Text="AIæ™ºèƒ½é€‰è‚¡" 
                   Style="{StaticResource PageTitleStyle}"
                   FontSize="20"
                   HorizontalOptions="Center"
                   Margin="{StaticResource BottomSmallMargin}"/>

            <!-- ä¼˜é›…çš„åŠ è½½æŒ‡ç¤ºå™¨ -->
            <Border Style="{StaticResource PrimaryCardStyle}" 
                IsVisible="{Binding IsBusy}"
                Margin="{StaticResource TopSmallMargin}">
                <Grid Padding="{StaticResource LargeSpacing}" ColumnDefinitions="Auto,*" ColumnSpacing="{StaticResource LargeSpacing}">
                    <ActivityIndicator Grid.Column="0"
                           IsRunning="{Binding IsBusy}"
                           Color="{StaticResource Primary}"
                           WidthRequest="24"
                           HeightRequest="24"
                           VerticalOptions="Center"/>
                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="{StaticResource TinySpacing}">
                        <Label Text="æ­£åœ¨åˆ†æžä¸­..."
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                        <Label Text="AIæ­£åœ¨ä¸ºæ‚¨ç²¾é€‰ä¼˜è´¨è‚¡ç¥¨ï¼Œè¯·ç¨å€™"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                    </VerticalStackLayout>
                </Grid>
            </Border>

            <!-- æ™ºèƒ½é€‰è‚¡è¾“å…¥åŒºåŸŸ -->
            <Border Style="{StaticResource PrimaryCardStyle}">
                <VerticalStackLayout Spacing="{StaticResource SmallSpacing}">
                    <!-- é€‰è‚¡æ¨¡å¼é€‰æ‹©å™¨ -->
                    <Label Text="é€‰è‚¡æ¨¡å¼" FontSize="14" FontAttributes="Bold" 
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                    <CollectionView ItemsSource="{Binding SelectionModes}"
                                    SelectedItem="{Binding SelectedMode}"
                                    SelectionMode="Single"
                                    HeightRequest="80">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="{StaticResource SmallSpacing}"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:SelectionModeItem">
                                <Border Padding="{StaticResource LargeSpacing},{StaticResource SmallSpacing}"
                                        StrokeShape="RoundRectangle 6"
                                        Stroke="{StaticResource Primary}"
                                        StrokeThickness="{Binding IsSelected, Converter={toolkit:BoolToObjectConverter TrueObject=2, FalseObject=1}}"
                                        BackgroundColor="{Binding IsSelected, Converter={toolkit:BoolToObjectConverter TrueObject={StaticResource Primary}, FalseObject=Transparent}}">
                                    <VerticalStackLayout Spacing="{StaticResource TinySpacing}" HorizontalOptions="Center">
                                        <Label Text="{Binding Icon}" 
                                               FontSize="20" 
                                               HorizontalOptions="Center"/>
                                        <Label Text="{Binding Name}" 
                                               FontSize="12" 
                                               FontAttributes="Bold"
                                               TextColor="{Binding IsSelected, Converter={toolkit:BoolToObjectConverter TrueObject=White, FalseObject={StaticResource Primary}}}"
                                               HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectModeCommand}"
                                                              CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    
                    <!-- ç»Ÿä¸€è¾“å…¥æ¡† -->
                    <Editor x:Name="ContentEditor"
                            Text="{Binding InputContent}"
                            Placeholder="{Binding CurrentPlaceholder}"
                            HeightRequest="120"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                            IsVisible="{Binding IsInputAreaVisible}"/>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="{StaticResource SmallSpacing}"
                          IsVisible="{Binding IsInputAreaVisible}">
                        <Button Grid.Column="0"
                                Text="{Binding CurrentButtonText}"
                                Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding ExecuteAnalysisCommand}"
                                IsEnabled="{Binding IsBusy, Converter={toolkit:InvertedBoolConverter}}"/>
                        <Button Grid.Column="1"
                                Text="å¿«é€Ÿé€‰è‚¡"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Command="{Binding ShowQuickSelectionCommand}"
                                IsEnabled="{Binding IsBusy, Converter={toolkit:InvertedBoolConverter}}"
                                IsVisible="False"/>
                        <Button Grid.Column="2"
                                Text="æ¸…é™¤"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Command="{Binding ClearContentCommand}"/>
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!-- å¿«é€Ÿé€‰è‚¡ç­–ç•¥ -->
            <Border Style="{StaticResource PrimaryCardStyle}"
                    IsVisible="{Binding IsQuickStrategyAreaVisible}">
                <VerticalStackLayout Spacing="{StaticResource SmallSpacing}">
                    <Label Text="å¿«é€Ÿé€‰è‚¡ç­–ç•¥" Style="{StaticResource SectionTitleStyle}"/>
                    <Label Text="é€‰æ‹©é¢„è®¾çš„é€‰è‚¡ç­–ç•¥ï¼Œå¿«é€ŸèŽ·å¾—æŠ•èµ„å»ºè®®" 
                           FontSize="12" 
                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>

                    <CollectionView ItemsSource="{Binding QuickStrategies}"
                                    SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout Orientation="Vertical" 
                                           Span="2" 
                                           HorizontalItemSpacing="{StaticResource SmallSpacing}" 
                                           VerticalItemSpacing="{StaticResource SmallSpacing}"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="agents:QuickSelectionStrategyInfo">
                                <Border Padding="{StaticResource SmallCardPadding}"
                                        StrokeShape="RoundRectangle 6"
                                        Stroke="{StaticResource Primary}"
                                        StrokeThickness="1"
                                        BackgroundColor="Transparent">
                                    <VerticalStackLayout Spacing="{StaticResource TinySpacing}">
                                        <Label Text="{Binding Name}" 
                                               FontSize="14" 
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                                        <Label Text="{Binding Description}" 
                                               FontSize="12" 
                                               TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                               LineBreakMode="WordWrap"/>
                                    </VerticalStackLayout>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ExecuteQuickSelectionCommand}"
                                                              CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
            
            <!-- é€‰è‚¡ç»“æžœæ˜¾ç¤ºåŒºåŸŸ -->
            <Border Style="{StaticResource PrimaryCardStyle}" 
                    IsVisible="{Binding HasResult}">
                <VerticalStackLayout Spacing="{StaticResource SmallSpacing}">
                    <Label Text="é€‰è‚¡ç»“æžœ" Style="{StaticResource SectionTitleStyle}"/>
                    
                    <!-- åˆ†æžæ‘˜è¦ -->
                    <Border Style="{StaticResource PrimaryCardStyle}" BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceVariantLight}, Dark={StaticResource SurfaceVariantDark}}">
                        <VerticalStackLayout Spacing="{StaticResource SmallSpacing}">
                            <Label Text="åˆ†æžæ‘˜è¦" FontSize="16" FontAttributes="Bold"/>
                            <Label Text="{Binding SelectionResult.AnalysisSummary}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                   LineBreakMode="WordWrap"/>
                        </VerticalStackLayout>
                    </Border>
                    
                    <!-- æŽ¨èè‚¡ç¥¨åˆ—è¡¨ -->
                    <Label Text="æŽ¨èè‚¡ç¥¨" FontSize="16" FontAttributes="Bold" Margin="{StaticResource TopSmallMargin}"/>
                    <CollectionView ItemsSource="{Binding RecommendedStocks}" 
                                    HeightRequest="400">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="agents:StockRecommendation">
                                <Border Style="{StaticResource PrimaryCardStyle}" 
                                        Margin="{StaticResource TopSmallMargin}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceVariantLight}, Dark={StaticResource SurfaceVariantDark}}">
                                    <Grid ColumnDefinitions="Auto,*,Auto" Padding="{StaticResource SmallCardPadding}" ColumnSpacing="{StaticResource SmallCardPadding}">
                                        <!-- ç¬¬ä¸€åˆ—ï¼šè‚¡ç¥¨ä»£ç å’Œåç§° -->
                                        <VerticalStackLayout Grid.Column="0" Spacing="{StaticResource TinySpacing}" VerticalOptions="Center">
                                            <Label Text="{Binding Symbol}" 
                                                   FontSize="16" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Primary}"/>
                                            <Label Text="{Binding Name}" 
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                                        </VerticalStackLayout>
                                        
                                        <!-- ç¬¬äºŒåˆ—ï¼šæŽ¨èç†ç”± -->
                                        <VerticalStackLayout Grid.Column="1" 
                                                           VerticalOptions="Center" 
                                                           Spacing="{StaticResource TinySpacing}">
                                            <Label Text="ðŸ’¡ æŽ¨èç†ç”±" 
                                                   FontSize="11" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Primary}"/>
                                            <Label Text="{Binding Reason}" 
                                                   FontSize="13"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                                   LineBreakMode="WordWrap"
                                                   MaxLines="2"/>
                                        </VerticalStackLayout>
                                        
                                        <!-- ç¬¬ä¸‰åˆ—ï¼šè¯„åˆ†å’Œé£Žé™©ç­‰çº§ -->
                                        <VerticalStackLayout Grid.Column="2" 
                                                           HorizontalOptions="End" 
                                                           VerticalOptions="Center"
                                                           Spacing="{StaticResource TinySpacing}">
                                            <Label Text="{Binding RecommendationScore, StringFormat='è¯„åˆ†: {0:F1}'}" 
                                                   FontSize="14" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Primary}"
                                                   HorizontalOptions="End"/>
                                            <Label Text="{Binding RiskLevel}" 
                                                   FontSize="11"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                                   HorizontalOptions="End"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    
                    <!-- é£Žé™©æç¤º -->
                    <Border Style="{StaticResource PrimaryCardStyle}" 
                            Margin="{StaticResource TopLargeMargin}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource WarningLight}, Dark={StaticResource WarningDark}}"
                            IsVisible="{Binding HasRiskWarnings}">
                        <VerticalStackLayout Spacing="{StaticResource SmallSpacing}">
                            <Label Text="âš ï¸ é£Žé™©æç¤º" 
                                   FontSize="16" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource OnWarningLight}, Dark={StaticResource OnWarningDark}}"/>
                            <Label Text="{Binding FormattedRiskWarnings}"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource OnWarningLight}, Dark={StaticResource OnWarningDark}}"
                                   LineBreakMode="WordWrap"/>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>