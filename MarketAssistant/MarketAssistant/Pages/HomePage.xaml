<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:MarketAssistant.Controls"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converts="clr-namespace:MarketAssistant.Converts"
             xmlns:viewmodels="clr-namespace:MarketAssistant.ViewModels"
             xmlns:telegrams="clr-namespace:MarketAssistant.Applications.Telegrams"
             xmlns:stocks="clr-namespace:MarketAssistant.Applications.Stocks.Models"
             x:Class="MarketAssistant.Pages.HomePage"
             x:DataType="viewmodels:HomeViewModel">
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- 页面特有资源 -->
            <x:Int32 x:Key="GridSpan">2</x:Int32>
            <converts:PriceChangeColorConverter x:Key="PriceChangeColorConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="{StaticResource PagePadding}"
          RowSpacing="{StaticResource SmallSpacing}"
          RowDefinitions="Auto,*">
          
        <!-- 顶部搜索区域 -->
        <Border Grid.Row="0" Style="{StaticResource PrimaryCardStyle}"
                    Padding="0">
            <Border.Shadow>
                <Shadow Brush="{StaticResource ShadowLight}"
                            Offset="0,2"
                            Radius="4"
                            Opacity="0.4"/>
            </Border.Shadow>
            <SearchBar x:Name="searchBar"
                           Placeholder="输入股票代码或名称"
                           SearchCommand="{Binding Search.SearchCommand}"
                           SearchCommandParameter="{Binding Text, Source={x:Reference searchBar}}"
                           BackgroundColor="Transparent"
                           CancelButtonColor="{StaticResource Primary}"
                           PlaceholderColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                           TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                           FontSize="16"/>
        </Border>

        <!-- 桌面端1:2:1三列布局 -->
        <Grid Grid.Row="1"
                  ColumnDefinitions="2*,3*,1*"
                  RowDefinitions="*" 
                  ColumnSpacing="{StaticResource SmallSpacing}">
            <!--7*24小时新闻快讯区域 (左侧)-->
            <controls:CardView Grid.Column="0" ShadowOpacity="0.4">
                <controls:CardView.Header>
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="7*24小时快讯" Style="{StaticResource SectionTitleStyle}"/>
                        <Label Grid.Column="1"
                                   Text="{Binding News.TelegraphRefreshCountdown}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                   VerticalOptions="Center"
                                   Margin="{StaticResource RightSmallMargin}"/>
                    </Grid>
                </controls:CardView.Header>
                <!--新闻快讯列表-->
                <CollectionView ItemsSource="{Binding News.Telegraphs}"
                                    SelectionMode="None"
                                    HorizontalOptions="Fill"
                                    VerticalScrollBarVisibility="Always">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical"
                                               ItemSpacing="{StaticResource SmallSpacing}"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.EmptyView>
                        <Label Text="暂无快讯数据"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                   HorizontalOptions="Center"/>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="telegrams:Telegram">
                            <Border Padding="{StaticResource ItemPadding}"
                                        StrokeShape="RoundRectangle 6"
                                        Stroke="Transparent"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource ItemBackgroundLight}, Dark={StaticResource ItemBackgroundDark}}">
                                <Grid ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0"
                                                             Spacing="{StaticResource TinySpacing}">
                                        <Label Text="{Binding Title}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                                        <Label Text="{Binding Content}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"
                                                   LineBreakMode="CharacterWrap"
                                                   HorizontalTextAlignment="Start"/>

                                        <HorizontalStackLayout Spacing="{StaticResource TinySpacing}"
                                                                   BindableLayout.ItemsSource="{Binding Stocks}">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="x:String">
                                                    <Border Padding="{StaticResource ItemPadding}"
                                                                Margin="{StaticResource TinyMargin}"
                                                                Stroke="{AppThemeBinding Light={StaticResource BorderLight}, Dark={StaticResource BorderDark}}"
                                                                StrokeThickness="0.5">
                                                        <Label Text="{Binding .}"
                                                                   FontSize="12"
                                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                                                    </Border>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                    <Label Grid.Column="1"
                                               Text="{Binding Time}"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                               VerticalOptions="Center"
                                               Margin="{StaticResource LeftSmallMargin}"/>
                                </Grid>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.News.OpenNewsCommand}"
                                                              CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </controls:CardView>

            <!-- 热门推荐区域 (中间) -->
            <controls:CardView Grid.Column="1">
                <controls:CardView.Header>
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
           Text="热门推荐"
           Style="{StaticResource SectionTitleStyle}"/>
                        <Image Grid.Column="1"
           Source="trending_icon.png"
           HeightRequest="{StaticResource SmallIconSize}"
           WidthRequest="{StaticResource SmallIconSize}"
           VerticalOptions="Center"/>
                    </Grid>
                </controls:CardView.Header>

                <!-- 热门股票列表 -->
                <CollectionView ItemsSource="{Binding HotStocks.HotStocks}"
                SelectionMode="None"
                HorizontalOptions="Fill">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout
            Orientation="Vertical"
            Span="2"
            HorizontalItemSpacing="{StaticResource SmallSpacing}"
            VerticalItemSpacing="{StaticResource SmallSpacing}"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.EmptyView>
                        <Label Text="暂无热门股票数据"
               TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
               HorizontalOptions="Center"/>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="stocks:HotStock">
                            <Border Padding="{StaticResource SmallCardPadding}"
                        Margin="0"
                        StrokeShape="RoundRectangle 6"
                        Stroke="Transparent"
                        BackgroundColor="{AppThemeBinding Light={StaticResource ItemBackgroundLight}, Dark={StaticResource ItemBackgroundDark}}"
                        HorizontalOptions="Fill"
                        VerticalOptions="Fill">
                                <!-- 精简: 两列 Grid, 左信息 右热度+收藏 -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <!-- 左侧信息 -->
                                    <VerticalStackLayout Grid.Column="0" Spacing="{StaticResource TinySpacing}">
                                        <HorizontalStackLayout Spacing="2">
                                            <Label Text="{Binding Market}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                                   Margin="{StaticResource RightTinyMargin}"/>
                                            <Label Text="{Binding Code}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                                        </HorizontalStackLayout>
                                        <Label Text="{Binding Name}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                                        <HorizontalStackLayout Spacing="4" Margin="{StaticResource TopTinyMargin}">
                                            <Label Text="{Binding CurrentPrice}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light={StaticResource DarkText}, Dark={StaticResource TextPrimaryDark}}"
                                                   Margin="{StaticResource RightSmallMargin}"/>
                                            <Label Text="{Binding ChangePercentage}"
                                                   FontSize="14"
                                                   TextColor="{Binding ChangePercentage, Converter={StaticResource PriceChangeColorConverter}}"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <!-- 右侧热度与收藏 -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="{StaticResource TinySpacing}" HorizontalOptions="End" VerticalOptions="Center">
                                        <Label Text="热度"
                                               FontSize="10"
                                               HorizontalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                                        <Label Text="{Binding HeatIndex}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               HorizontalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource InfoBlue}, Dark={StaticResource InfoBlueLight}}"/>
                                        <ImageButton BackgroundColor="Transparent"
                                                     Source="tab_favorites.png"
                                                     Scale="0.6"
                                                     HorizontalOptions="Center"
                                                     Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.HotStocks.AddToFavoriteCommand}"
                                                     CommandParameter="{Binding .}"
                                                     x:Name="favoriteButton"
                                                     Opacity="0" />
                                    </VerticalStackLayout>
                                </Grid>

                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.HotStocks.SelectHotStockCommand}"
                                              CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>

                                <!--视觉状态管理-->
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal">
                                            <VisualState.Setters>
                                                <Setter TargetName="favoriteButton" Property="Opacity" Value="0" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState Name="PointerOver">
                                            <VisualState.Setters>
                                                <Setter TargetName="favoriteButton" Property="Opacity" Value="1" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </controls:CardView>

            <!-- 最近查看区域 (右侧) -->
            <controls:CardView Grid.Column="2" 
                                   Header="最近查看">
                <!-- 最近查看的股票数据列表 -->
                <CollectionView ItemsSource="{Binding RecentStocks.RecentStocks}"
                                        SelectionMode="None"
                                        HorizontalOptions="Fill">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center"
                                                     VerticalOptions="Center"
                                                     Spacing="{StaticResource SmallSpacing}">
                            <Image Source="empty_data.png"
                                           HeightRequest="64"
                                           WidthRequest="64"
                                           Opacity="0.6"/>
                            <Label Text="暂无查看记录"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                           HorizontalOptions="Center"/>
                            <Label Text="搜索或浏览热门股票以添加记录"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                           HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="stocks:StockItem">
                            <Border Margin="{StaticResource TopTinyMargin}"
                                            Padding="{StaticResource SmallCardPadding}"
                                            StrokeShape="RoundRectangle 6"
                                            Stroke="Transparent"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource ItemBackgroundLight}, Dark={StaticResource ItemBackgroundDark}}">
                                <Grid ColumnDefinitions="*,Auto">
                                    <VerticalStackLayout Grid.Column="0" Spacing="{StaticResource TinySpacing}" VerticalOptions="Center">
                                        <Label Text="{Binding Name}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}"/>
                                        <Label Text="{Binding Code}"
                                                       FontSize="12"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"/>
                                    </VerticalStackLayout>

                                    <!-- 收藏按钮 -->
                                    <ImageButton Grid.Column="1"
                                                         Source="tab_favorites.png"
                                                         Scale="0.6"
                                                         BackgroundColor="Transparent"
                                                         VerticalOptions="Center"
                                                         Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RecentStocks.AddToFavoriteCommand}"
                                                         CommandParameter="{Binding .}"
                                                         x:Name="recentFavoriteButton"
                                                         Opacity="0"/>
                                </Grid>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RecentStocks.SelectRecentStockCommand}"
                                                                  CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>

                                <!-- 视觉状态管理 -->
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal">
                                            <VisualState.Setters>
                                                <Setter TargetName="recentFavoriteButton" Property="Opacity" Value="0" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState Name="PointerOver">
                                            <VisualState.Setters>
                                                <Setter TargetName="recentFavoriteButton" Property="Opacity" Value="1" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </controls:CardView >
        </Grid>
    </Grid>
</ContentPage>