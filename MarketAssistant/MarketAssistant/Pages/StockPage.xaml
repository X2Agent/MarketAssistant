<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:MarketAssistant.Controls"
             xmlns:viewmodels="clr-namespace:MarketAssistant.ViewModels"
             xmlns:converts="clr-namespace:MarketAssistant.Converts"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="MarketAssistant.Pages.StockPage"
             x:DataType="viewmodels:StockViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- 转换器 -->
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            
            <!-- 页面特有资源 -->
            <!-- 渐变色定义 - 页面特有 -->
            <LinearGradientBrush x:Key="CardGradient" StartPoint="0,0" EndPoint="0,1">
                <GradientStop Color="{StaticResource GradientWhite}" Offset="0" />
                <GradientStop Color="{StaticResource GradientLightGray}" Offset="1" />
            </LinearGradientBrush>
            
            <LinearGradientBrush x:Key="PrimaryGradient" StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="{StaticResource PrimaryBlue}" Offset="0" />
                <GradientStop Color="{StaticResource PrimaryBlueLight}" Offset="1" />
            </LinearGradientBrush>

            <!-- 页面特有样式 -->
            <Style x:Key="StockCompactCardStyle" TargetType="Border">
                <Setter Property="Background" Value="{StaticResource CardGradient}" />
                <Setter Property="StrokeShape" Value="RoundRectangle 8" />
                <Setter Property="Stroke" Value="Transparent" />
                <Setter Property="Padding" Value="{StaticResource SmallCardPadding}" />
                <Setter Property="Margin" Value="{StaticResource TinyMargin}" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="{AppThemeBinding Light={StaticResource ShadowLight}, Dark={StaticResource ShadowDark}}" 
                                Offset="0,2" 
                                Radius="4" 
                                Opacity="0.1" />
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="StockChartCardStyle" TargetType="Border">
                <Setter Property="Background" Value="{StaticResource CardGradient}" />
                <Setter Property="StrokeShape" Value="RoundRectangle 12" />
                <Setter Property="Stroke" Value="Transparent" />
                <Setter Property="Padding" Value="{StaticResource SmallCardPadding}" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="{AppThemeBinding Light={StaticResource ShadowLight}, Dark={StaticResource ShadowDark}}" 
                                Offset="0,4" 
                                Radius="8" 
                                Opacity="0.15" />
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="StockActiveButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="{StaticResource PrimaryGradient}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="BorderWidth" Value="0" />
                <Setter Property="CornerRadius" Value="6" />
                <Setter Property="Padding" Value="{StaticResource SmallCardPadding}" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <Style x:Key="StockCompactTitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="20" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
            </Style>

            <Style x:Key="PriceStyle" TargetType="Label">
                <Setter Property="FontSize" Value="28" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <Style x:Key="StockSmallLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
            </Style>

            <Style x:Key="StockDataLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="13" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextPrimaryLight}, Dark={StaticResource TextPrimaryDark}}" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- 现代化渐变背景 -->
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="{StaticResource GradientLightGray}" Offset="0" />
            <GradientStop Color="{StaticResource GradientMediumGray}" Offset="1" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <Grid Padding="{StaticResource SmallCardPadding}" RowDefinitions="Auto,*" RowSpacing="{StaticResource SmallSpacing}">
        
        <!-- 股票基本信息卡片 - 水平布局版 -->
        <Border Grid.Row="0" Style="{StaticResource StockCompactCardStyle}">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,*,Auto,Auto" ColumnSpacing="{StaticResource TinySpacing}">
                
                <!-- 股票名称 -->
                <Label Grid.Column="0"
                       Text="{Binding StockName}" 
                       Style="{StaticResource StockCompactTitleStyle}" 
                       VerticalOptions="Center" />
                
                <!-- 股票代码 -->
                <Border Grid.Column="1"
                        BackgroundColor="{StaticResource Info}" 
                        StrokeShape="RoundRectangle 4" 
                        Padding="{StaticResource SmallHorizontalTinyVerticalPadding}"
                        VerticalOptions="Center">
                    <Label Text="{Binding StockCode}" 
                           FontSize="11" 
                           FontAttributes="Bold" 
                           TextColor="White" />
                </Border>
                
                <!-- 当前价格 -->
                <Label Grid.Column="2"
                       Text="{Binding CurrentPrice, StringFormat='{0:F2}'}" 
                       Style="{StaticResource PriceStyle}"
                       TextColor="{Binding PriceChange, Converter={StaticResource PriceChangeColorConverter}}" 
                       VerticalOptions="Center"
                       Margin="16,0,0,0" />
                
                <!-- 涨跌信息 -->
                <StackLayout Grid.Column="3" Orientation="Vertical" Spacing="2" VerticalOptions="Center">
                    <StackLayout Orientation="Horizontal" Spacing="4">
                        <Label Text="{Binding PriceChange, StringFormat='{0:F2}'}" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="{Binding PriceChange, Converter={StaticResource PriceChangeColorConverter}}" />
                        <Label Text="{Binding PriceChangePercent, StringFormat='({0:F2}%)'}" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="{Binding PriceChange, Converter={StaticResource PriceChangeColorConverter}}" />
                    </StackLayout>
                    <Label Text="较昨收" 
                           Style="{StaticResource SmallLabelStyle}" 
                           HorizontalOptions="Center" />
                </StackLayout>
                
                <!-- 填充空间 -->
                <BoxView Grid.Column="4" IsVisible="False" />
                
                <!-- AI分析按钮 -->
                <Button Grid.Column="5"
                        Text="🤖 AI分析" 
                        Command="{Binding NavigateToAnalysisCommand}" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        VerticalOptions="Center" />
                
                <!-- 刷新按钮 -->
                <Button Grid.Column="6"
                        Text="🔄 刷新" 
                        Command="{Binding RefreshDataCommand}" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        VerticalOptions="Center" />
            </Grid>
        </Border>

        <!-- K线图表区域 - 只在数据加载成功时显示 -->
        <Border Grid.Row="1" Style="{StaticResource PrimaryCardStyle}" VerticalOptions="FillAndExpand"
                IsVisible="{Binding HasError, Converter={StaticResource InvertedBoolConverter}}">
            <StackLayout VerticalOptions="FillAndExpand" Spacing="10">

                <!-- 图表控制区域 -->
                <Grid Padding="{StaticResource ItemPadding}" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                    <!-- 图例 -->
                    <HorizontalStackLayout Grid.Column="0" Spacing="12">
                        <HorizontalStackLayout Spacing="6">
                            <Border BackgroundColor="{StaticResource UpColor}" 
                                    WidthRequest="12" 
                                    HeightRequest="12" 
                                    StrokeShape="RoundRectangle 3" />
                            <Label Text="上涨" Style="{StaticResource SmallLabelStyle}" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="6">
                            <Border BackgroundColor="{StaticResource DownColor}" 
                                    WidthRequest="12" 
                                    HeightRequest="12" 
                                    StrokeShape="RoundRectangle 3" />
                            <Label Text="下跌" Style="{StaticResource SmallLabelStyle}" VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </HorizontalStackLayout>

                    <!-- 时间周期按钮组 -->
                    <HorizontalStackLayout Grid.Column="2" Spacing="4">
                        <Button Text="分时" 
                                Command="{Binding ChangeKLineTypeCommand}" 
                                CommandParameter="minute"
                                FontSize="12"
                                FontAttributes="Bold"
                                CornerRadius="6"
                                Padding="{StaticResource SmallButtonPadding}"
                                BorderWidth="1"
                                BorderColor="{StaticResource PrimaryColor}"
                                BackgroundColor="{Binding IsMinuteSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#007bff,Transparent'}"
                                TextColor="{Binding IsMinuteSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White,#007bff'}" />

                        <Button Text="日K" 
                                Command="{Binding ChangeKLineTypeCommand}" 
                                CommandParameter="daily"
                                FontSize="12"
                                FontAttributes="Bold"
                                CornerRadius="6"
                                Padding="{StaticResource SmallButtonPadding}"
                                BorderWidth="1"
                                BorderColor="{StaticResource PrimaryColor}"
                                BackgroundColor="{Binding IsDailySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#007bff,Transparent'}"
                                TextColor="{Binding IsDailySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White,#007bff'}" />

                        <Button Text="周K" 
                                Command="{Binding ChangeKLineTypeCommand}" 
                                CommandParameter="weekly"
                                FontSize="12"
                                FontAttributes="Bold"
                                CornerRadius="6"
                                Padding="{StaticResource SmallButtonPadding}"
                                BorderWidth="1"
                                BorderColor="{StaticResource PrimaryColor}"
                                BackgroundColor="{Binding IsWeeklySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#007bff,Transparent'}"
                                TextColor="{Binding IsWeeklySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White,#007bff'}" />

                        <Button Text="月K" 
                                Command="{Binding ChangeKLineTypeCommand}" 
                                CommandParameter="monthly"
                                FontSize="12"
                                FontAttributes="Bold"
                                CornerRadius="6"
                                Padding="{StaticResource SmallButtonPadding}"
                                BorderWidth="1"
                                BorderColor="{StaticResource PrimaryColor}"
                                BackgroundColor="{Binding IsMonthlySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#007bff,Transparent'}"
                                TextColor="{Binding IsMonthlySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White,#007bff'}" />
                    </HorizontalStackLayout>
                </Grid>

                <StackLayout VerticalOptions="FillAndExpand">
                    <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" HorizontalOptions="Center" VerticalOptions="Center" Scale="1.5" />

                    <controls:StockWebChartView x:Name="WebChartView" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" 
                                              IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}" />
                </StackLayout>
            </StackLayout>
        </Border>
        
        <!-- 错误状态显示区域 -->
        <Border Grid.Row="1" Style="{StaticResource PrimaryCardStyle}" VerticalOptions="FillAndExpand"
                IsVisible="{Binding HasError}">
            <VerticalStackLayout HorizontalOptions="Center" 
                               VerticalOptions="Center" 
                               Spacing="{StaticResource TinySpacing}">
                <Label Text="⚠️" FontSize="48" HorizontalOptions="Center" />
                <Label Text="数据加载失败" 
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{StaticResource ErrorColor}"
                       HorizontalOptions="Center" />
                <Label Text="{Binding ErrorMessage}" 
                       FontSize="14"
                       TextColor="{StaticResource ErrorColor}"
                       HorizontalOptions="Center" 
                       HorizontalTextAlignment="Center"
                       MaxLines="3" />
                <Button Text="🔄 重新加载" 
                        Command="{Binding RefreshDataCommand}" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        Margin="0,16,0,0" />
            </VerticalStackLayout>
        </Border>
    </Grid>
</ContentPage>