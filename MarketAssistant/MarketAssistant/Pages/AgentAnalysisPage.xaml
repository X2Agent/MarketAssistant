<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MarketAssistant.ViewModels"
             xmlns:converters="clr-namespace:MarketAssistant.Converts"
             xmlns:views="clr-namespace:MarketAssistant.Views"
             xmlns:controls="clr-namespace:MarketAssistant.Controls"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="MarketAssistant.Pages.AgentAnalysisPage"
             x:DataType="viewmodels:AgentAnalysisViewModel"
             x:Name="ParentPage">

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:DoubleConverter x:Key="DoubleConverter" />
            
            <!-- é¡µé¢ç‰¹æœ‰èµ„æº - FABæŒ‰é’®æ ·å¼ -->
            <Style x:Key="FabButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="#2196F3" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontSize" Value="22" />
                <Setter Property="CornerRadius" Value="28" />
                <Setter Property="WidthRequest" Value="56" />
                <Setter Property="HeightRequest" Value="56" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="Margin" Value="{StaticResource LargeMargin}" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ - ä»…åœ¨åˆ†æžæ—¶æ˜¾ç¤º -->
        <views:ProgressDisplayView 
            IsVisible="{Binding IsBusy}"
            IsProgressVisible="{Binding IsBusy}"
            IsAnalysisInProgress="{Binding IsAnalysisInProgress}"
            AnalysisStage="{Binding AnalysisStage}"
            ShowDetailsCommand="{Binding ShowAnalysisDetailsCommand}"/>

        <!-- åˆ†æžå®ŒæˆåŽçš„å†…å®¹åŒºåŸŸï¼ˆåŒ…å«æµ®åŠ¨æ“ä½œæŒ‰é’®ï¼‰ -->
        <Grid IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}">
            <!-- æ™ºèƒ½åˆ†æžæŠ¥å‘ŠåŒºåŸŸ -->
            <ContentView BindingContext="{Binding AnalysisReportViewModel}"
                         IsVisible="{Binding Source={x:Reference ParentPage}, Path=BindingContext.IsRawDataViewVisible, Converter={StaticResource InvertedBoolConverter}}">
                <views:AnalysisReportView />
            </ContentView>

            <!-- åŽŸå§‹æ•°æ®å±•ç¤ºåŒºåŸŸ -->
            <views:RawDataView
                AnalysisMessages="{Binding AnalysisMessages}" 
                IsVisible="{Binding IsRawDataViewVisible}" />
            
            <!-- æ°´å°æŽ§ä»¶ -->
            <controls:WatermarkView 
                Text="æ•°æ®æ¥æºç½‘ç»œï¼Œä»…ä¾›å‚è€ƒã€‚æŠ•èµ„æœ‰é£Žé™©ï¼Œå…¥å¸‚éœ€è°¨æ…Žï¼" 
                OpacityValue="0.4" 
                Angle="-30" 
                TextColor="{StaticResource Gray900}" 
                FontSize="28" 
                HorizontalRepeatCount="2" 
                VerticalRepeatCount="4" 
                InputTransparent="True" 
                ZIndex="999" />
            
            <!-- æµ®åŠ¨æ“ä½œæŒ‰é’®(FAB) -->
            <StackLayout HorizontalOptions="End" VerticalOptions="End" 
                         ZIndex="1000" Margin="{StaticResource BottomRightLargeMargin}">
                <!-- æŸ¥çœ‹Kçº¿å›¾æŒ‰é’® -->
                <Button 
                    Style="{StaticResource FabButtonStyle}"
                    Text="ðŸ“ˆ" 
                    FontSize="24"
                    Command="{Binding ViewKLineChartCommand}"
                    ToolTipProperties.Text="æŸ¥çœ‹Kçº¿å›¾" />
                    
                <!-- åˆ‡æ¢è§†å›¾æŒ‰é’® -->
                <Button 
                    Style="{StaticResource FabButtonStyle}"
                    Text="â‡„" 
                    FontSize="24"
                    Command="{Binding ToggleViewCommand}"
                    ToolTipProperties.Text="åˆ‡æ¢è§†å›¾" />                
            </StackLayout>
        </Grid>
    </Grid>
</ContentPage>