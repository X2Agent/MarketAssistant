<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:converts="using:MarketAssistant.Converts"
             xmlns:controls="using:MarketAssistant.Views.Controls"
             xmlns:components="using:MarketAssistant.Views.Components"
             mc:Ignorable="d" d:DesignWidth="480" d:DesignHeight="800"
             x:Class="MarketAssistant.Views.Components.ChatSidebarView"
             x:DataType="vm:ChatSidebarViewModel"
             x:Name="Root">

    <UserControl.Resources>
        <!-- 图标路径定义 -->
        <StreamGeometry x:Key="IconClose">M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z</StreamGeometry>
        <StreamGeometry x:Key="IconSend">M2.01 21L23 12 2.01 3 2 10l15 2-15 2z</StreamGeometry>
        <StreamGeometry x:Key="IconRobot">M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H18A2,2 0 0,1 20,9V18A2,2 0 0,1 18,20H6A2,2 0 0,1 4,18V9A2,2 0 0,1 6,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M6,9V18H18V9H6M15,14A1,1 0 0,0 14,15A1,1 0 0,0 15,16A1,1 0 0,0 16,15A1,1 0 0,0 15,14M9,14A1,1 0 0,0 8,15A1,1 0 0,0 9,16A1,1 0 0,0 10,15A1,1 0 0,0 9,14Z</StreamGeometry>
        <StreamGeometry x:Key="IconUser">M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z</StreamGeometry>
        <StreamGeometry x:Key="IconChat">M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H6L4,18V4H20</StreamGeometry>

        <!-- 局部尺寸定义 -->
        <x:Double x:Key="HeaderHeight">56</x:Double>
        <x:Double x:Key="AvatarSize">36</x:Double>
        <x:Double x:Key="AvatarIconSize">20</x:Double>
        <x:Double x:Key="HeaderIconSize">20</x:Double>
        <x:Double x:Key="CloseButtonSize">32</x:Double>
        <x:Double x:Key="CloseIconSize">12</x:Double>
        <x:Double x:Key="SendIconSize">18</x:Double>
        <x:Double x:Key="IconButtonSize">44</x:Double>
        <x:Double x:Key="InputAreaMinHeight">48</x:Double>
        <x:Double x:Key="InputBoxMaxHeight">120</x:Double>
        <CornerRadius x:Key="AvatarCornerRadius">18</CornerRadius>
        <CornerRadius x:Key="InputAreaCornerRadius">24</CornerRadius>
        <CornerRadius x:Key="CloseButtonCornerRadius">16</CornerRadius>
        <CornerRadius x:Key="SendButtonCornerRadius">22</CornerRadius>
        <CornerRadius x:Key="BubbleLeftCornerRadius">0,16,16,16</CornerRadius>
        <CornerRadius x:Key="BubbleRightCornerRadius">16,0,16,16</CornerRadius>
        <Thickness x:Key="HeaderPadding">16,0</Thickness>
        <Thickness x:Key="HeaderIconMargin">0,0,12,0</Thickness>
        <Thickness x:Key="CloseButtonMargin">0,0,12,0</Thickness>
        <Thickness x:Key="ChatListPadding">16</Thickness>
        <Thickness x:Key="MessageItemMargin">0,8</Thickness>
        <Thickness x:Key="AvatarLeftMargin">0,0,12,0</Thickness>
        <Thickness x:Key="AvatarRightMargin">12,0,0,0</Thickness>
        <Thickness x:Key="BubbleHeaderMargin">4,0,0,4</Thickness>
        <Thickness x:Key="BubbleTimeMargin">8,0,0,0</Thickness>
        <Thickness x:Key="BubbleRightHeaderMargin">0,0,4,4</Thickness>
        <Thickness x:Key="BubbleRightTimeMargin">0,0,8,0</Thickness>
        <Thickness x:Key="ThinkingMargin">0,0,0,8</Thickness>
        <Thickness x:Key="InputAreaPadding">16,12</Thickness>
        <Thickness x:Key="InputBoxMargin">12,2</Thickness>
        <Thickness x:Key="SendButtonMargin">12,0,0,0</Thickness>
        <Thickness x:Key="SendIconMargin">2,0,0,0</Thickness>
        <Thickness x:Key="BottomBorderThickness">0,0,0,1</Thickness>
        <Thickness x:Key="TopBorderThickness">0,1,0,0</Thickness>
        <Thickness x:Key="DefaultBorderThickness">1</Thickness>
        <Thickness x:Key="NoBorderThickness">0</Thickness>
        <BoxShadows x:Key="SubtleBoxShadow">0 2 4 0 #20000000</BoxShadows>
        <BoxShadows x:Key="InputAreaBoxShadow">0 -2 8 0 #08000000</BoxShadows>
        <BoxShadows x:Key="CardBoxShadow">0 1 3 0 #15000000</BoxShadows>
        <BoxShadows x:Key="UserBubbleBoxShadow">0 2 4 0 #301976D2</BoxShadows>
    </UserControl.Resources>

    <DockPanel Background="{DynamicResource PageBackgroundBrush}">
        
        <!-- 1. 标题栏 -->
        <Border DockPanel.Dock="Top" 
                Height="{StaticResource HeaderHeight}" 
                Background="{DynamicResource CardBackgroundBrush}" 
                BorderBrush="{DynamicResource DividerBrush}" 
                BorderThickness="{StaticResource BottomBorderThickness}">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="{StaticResource HeaderPadding}">
                    <PathIcon Data="{StaticResource IconChat}" 
                              Foreground="{DynamicResource Primary}" 
                              Width="{StaticResource HeaderIconSize}" Height="{StaticResource HeaderIconSize}" 
                              Margin="{StaticResource HeaderIconMargin}"/>
                    <TextBlock Text="智能助手" 
                               FontSize="{StaticResource SubTitleFontSize}" 
                               FontWeight="SemiBold" 
                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                </StackPanel>
                
                <Button Grid.Column="1" 
                        Command="{Binding #Root.CloseCommand}"
                        Background="Transparent"
                        Width="{StaticResource CloseButtonSize}" Height="{StaticResource CloseButtonSize}"
                        CornerRadius="{StaticResource CloseButtonCornerRadius}"
                        Margin="{StaticResource CloseButtonMargin}"
                        Padding="0">
                    <PathIcon Data="{StaticResource IconClose}" 
                              Width="{StaticResource CloseIconSize}" Height="{StaticResource CloseIconSize}" 
                              Foreground="{DynamicResource TextSecondaryBrush}"/>
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource SurfaceVariantBrush}"/>
                        </Style>
                    </Button.Styles>
                </Button>
            </Grid>
        </Border>

        <!-- 3. 输入区域 -->
        <Border DockPanel.Dock="Bottom" 
                Background="{DynamicResource CardBackgroundBrush}" 
                BorderBrush="{DynamicResource DividerBrush}" 
                BorderThickness="{StaticResource TopBorderThickness}"
                Padding="{StaticResource InputAreaPadding}"
                BoxShadow="{StaticResource InputAreaBoxShadow}">
            <Grid ColumnDefinitions="*,Auto">
                <Border Grid.Column="0" 
                        Background="{DynamicResource PageBackgroundBrush}" 
                        CornerRadius="{StaticResource InputAreaCornerRadius}" 
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="{StaticResource DefaultBorderThickness}"
                        MinHeight="{StaticResource InputAreaMinHeight}">
                    <TextBox x:Name="MessageEntry"
                             Text="{Binding UserInput}" 
                             Watermark="输入您的问题..." 
                             BorderThickness="{StaticResource NoBorderThickness}" 
                             Background="Transparent"
                             Margin="{StaticResource InputBoxMargin}"
                             FontSize="{StaticResource LabelFontSize}"
                             VerticalContentAlignment="Center"
                             AcceptsReturn="True"
                             MaxHeight="{StaticResource InputBoxMaxHeight}"
                             IsEnabled="{Binding IsProcessing, Converter={x:Static BoolConverters.Not}}">
                        <TextBox.Styles>
                            <Style Selector="TextBox:focus /template/ Border#PART_BorderElement">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                            </Style>
                            <Style Selector="TextBox:disabled /template/ Border#PART_BorderElement">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                            </Style>
                        </TextBox.Styles>
                    </TextBox>
                </Border>
                
                <Button Grid.Column="1" 
                        Command="{Binding SendMessageCommand}"
                        Width="{StaticResource IconButtonSize}" Height="{StaticResource IconButtonSize}" 
                        CornerRadius="{StaticResource SendButtonCornerRadius}" 
                        Background="{DynamicResource Primary}"
                        Margin="{StaticResource SendButtonMargin}"
                        Padding="0"
                        IsEnabled="{Binding IsProcessing, Converter={x:Static BoolConverters.Not}}">
                    <PathIcon Data="{StaticResource IconSend}" 
                              Foreground="White" 
                              Width="{StaticResource SendIconSize}" Height="{StaticResource SendIconSize}"
                              Margin="{StaticResource SendIconMargin}"/> <!-- 微调图标位置使其视觉居中 -->
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource PrimaryLight}"/>
                        </Style>
                        <Style Selector="Button:pressed /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource PrimaryDark}"/>
                        </Style>
                        <Style Selector="Button:disabled /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource TextDisabledBrush}"/>
                        </Style>
                    </Button.Styles>
                </Button>
            </Grid>
        </Border>

        <!-- 2. 消息列表 -->
        <ListBox x:Name="ChatListBox"
                 ItemsSource="{Binding ChatMessages}" 
                 Background="Transparent" 
                 Margin="0"
                 Padding="{StaticResource ChatListPadding}"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 ScrollViewer.VerticalScrollBarVisibility="Auto">
            <ListBox.Styles>
                <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Template">
                        <ControlTemplate>
                            <ContentPresenter Name="PART_ContentPresenter"
                                              Background="{TemplateBinding Background}"
                                              BorderBrush="{TemplateBinding BorderBrush}"
                                              BorderThickness="{TemplateBinding BorderThickness}"
                                              CornerRadius="{TemplateBinding CornerRadius}"
                                              ContentTemplate="{TemplateBinding ContentTemplate}"
                                              Content="{TemplateBinding Content}"
                                              Padding="{TemplateBinding Padding}"
                                              VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                              HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}" />
                        </ControlTemplate>
                    </Setter>
                </Style>
                <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
            </ListBox.Styles>
            
            <ListBox.ItemTemplate>
                <DataTemplate x:DataType="vm:ChatMessageAdapter">
                    <Panel Margin="{StaticResource MessageItemMargin}">
                        <!-- AI 消息布局 (左侧) -->
                        <Grid ColumnDefinitions="Auto,*" IsVisible="{Binding !IsUser}">
                            <!-- 头像 -->
                            <Border Grid.Column="0" 
                                    Width="{StaticResource AvatarSize}" Height="{StaticResource AvatarSize}" 
                                    CornerRadius="{StaticResource AvatarCornerRadius}" 
                                    Background="{DynamicResource PrimaryLight}"
                                    VerticalAlignment="Top"
                                    Margin="{StaticResource AvatarLeftMargin}"
                                    BoxShadow="{StaticResource SubtleBoxShadow}">
                                <PathIcon Data="{StaticResource IconRobot}" Foreground="White" Width="{StaticResource AvatarIconSize}" Height="{StaticResource AvatarIconSize}"/>
                            </Border>
                            
                            <!-- 气泡内容 -->
                            <StackPanel Grid.Column="1" HorizontalAlignment="Left" MaxWidth="{StaticResource MaxChatBubbleWidth}">
                                <StackPanel Orientation="Horizontal" Margin="{StaticResource BubbleHeaderMargin}">
                                    <TextBlock Text="{Binding Sender}" FontSize="{StaticResource SmallFontSize}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock Text="{Binding FormattedTime}" FontSize="{StaticResource MiniFontSize}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="{StaticResource BubbleTimeMargin}" VerticalAlignment="Bottom"/>
                                </StackPanel>
                                
                                <Border Background="{DynamicResource CardBackgroundBrush}"
                                        CornerRadius="{StaticResource BubbleLeftCornerRadius}"
                                        Padding="{StaticResource CardPadding}"
                                        BoxShadow="{StaticResource CardBoxShadow}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        BorderThickness="{StaticResource DefaultBorderThickness}">
                                    <StackPanel>
                                        <!-- 思考状态 -->
                                        <StackPanel Orientation="Horizontal" Spacing="{StaticResource SmallSpacing}" IsVisible="{Binding IsThinking}" Margin="{StaticResource ThinkingMargin}">
                                            <ProgressBar IsIndeterminate="True" Width="{StaticResource LargeSpacing}" Height="{StaticResource LargeSpacing}" Theme="{StaticResource CircularProgressBarTheme}"/>
                                            <TextBlock Text="思考中..." FontSize="{StaticResource BodyFontSize}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        
                                        <!-- 文本内容 -->
                                        <controls:RichTextBlock Text="{Binding Content}" IsVisible="{Binding !IsAdaptiveCard}"/>
                                        
                                        <!-- Adaptive Card -->
                                        <components:AdaptiveCardView Card="{Binding AdaptiveCard}" IsVisible="{Binding IsAdaptiveCard}"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Grid>

                        <!-- 用户消息布局 (右侧) -->
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding IsUser}">
                            <!-- 气泡内容 -->
                            <StackPanel Grid.Column="0" HorizontalAlignment="Right" MaxWidth="{StaticResource MaxChatBubbleWidth}">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="{StaticResource BubbleRightHeaderMargin}">
                                    <TextBlock Text="{Binding FormattedTime}" FontSize="{StaticResource MiniFontSize}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="{StaticResource BubbleRightTimeMargin}" VerticalAlignment="Bottom"/>
                                    <TextBlock Text="{Binding Sender}" FontSize="{StaticResource SmallFontSize}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </StackPanel>

                                <Border Background="{DynamicResource Primary}"
                                        CornerRadius="{StaticResource BubbleRightCornerRadius}"
                                        Padding="{StaticResource DefaultCardPadding}"
                                        BoxShadow="{StaticResource UserBubbleBoxShadow}">
                                    <TextBlock Text="{Binding Content}" 
                                               Foreground="White" 
                                               TextWrapping="Wrap"
                                               FontSize="{StaticResource LabelFontSize}"
                                               LineHeight="20"/>
                                </Border>
                            </StackPanel>

                            <!-- 头像 -->
                            <Border Grid.Column="1" 
                                    Width="{StaticResource AvatarSize}" Height="{StaticResource AvatarSize}" 
                                    CornerRadius="{StaticResource AvatarCornerRadius}" 
                                    Background="{DynamicResource SecondaryLight}"
                                    VerticalAlignment="Top"
                                    Margin="{StaticResource AvatarRightMargin}"
                                    BoxShadow="{StaticResource SubtleBoxShadow}">
                                <PathIcon Data="{StaticResource IconUser}" Foreground="White" Width="{StaticResource AvatarIconSize}" Height="{StaticResource AvatarIconSize}"/>
                            </Border>
                        </Grid>
                    </Panel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
    </DockPanel>
</UserControl>
