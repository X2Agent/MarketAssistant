<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:converts="using:MarketAssistant.Converts"
             xmlns:controls="using:MarketAssistant.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="480" d:DesignHeight="800"
             x:Class="MarketAssistant.Views.Components.ChatSidebarView"
             x:DataType="vm:ChatSidebarViewModel"
             x:Name="Root">

    <DockPanel Background="{DynamicResource PageBackgroundBrush}">
        
        <!-- 标题栏 -->
        <DockPanel DockPanel.Dock="Top"
                   Background="{DynamicResource CardBackgroundBrush}"
                   Height="{StaticResource HeaderHeight}">
            
            <Button DockPanel.Dock="Right"
                    Content="✕"
                    FontSize="{StaticResource SubTitleFontSize}"
                    Background="Transparent"
                    Width="{StaticResource SmallIconButtonSize}"
                    Height="{StaticResource SmallIconButtonSize}"
                    CornerRadius="{StaticResource LargeCornerRadius}"
                    Margin="{StaticResource SmallMargin}"
                    Command="{Binding #Root.CloseCommand}"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center"/>
            
            <TextBlock Text="智能对话" 
                       FontSize="{StaticResource SubTitleFontSize}"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"
                       Margin="{StaticResource PagePadding}" />
        </DockPanel>
        
        <!-- 标题栏分割线 -->
        <Border DockPanel.Dock="Top"
                Height="{StaticResource DividerHeight}"
                Background="{DynamicResource BorderBrush}" />

        <!-- 输入区域 -->
        <Border DockPanel.Dock="Bottom" 
                Margin="{StaticResource PagePadding}"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="{StaticResource DefaultBorderThickness}"
                CornerRadius="{StaticResource DefaultCornerRadius}"
                BoxShadow="{StaticResource SubtleBoxShadow}">
            
            <Grid ColumnDefinitions="*,Auto" 
                  Margin="{StaticResource PagePadding}">
                
                <!-- 输入框 -->
                <TextBox Grid.Column="0"
                         x:Name="MessageEntry"
                         Text="{Binding UserInput}"
                         Watermark="询问关于股票分析的问题..."
                         FontSize="{StaticResource LabelFontSize}"
                         MinHeight="{StaticResource InputHeight}"
                         Background="Transparent"
                         BorderThickness="{StaticResource NoBorderThickness}"
                         Padding="{StaticResource TinyMargin}"
                         IsEnabled="{Binding IsProcessing, Converter={x:Static BoolConverters.Not}}"
                         VerticalContentAlignment="Center"
                         TextWrapping="Wrap"
                         MaxHeight="{StaticResource MaxInputHeight}"
                         AcceptsReturn="True">
                    <TextBox.Styles>
                        <Style Selector="TextBox:focus /template/ Border#PART_BorderElement">
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                        </Style>
                    </TextBox.Styles>
                </TextBox>

                <!-- 发送按钮 -->
                <Button Grid.Column="1"
                        Command="{Binding SendMessageCommand}"
                        Background="{DynamicResource PrimaryBrush}"
                        Width="{StaticResource IconButtonSize}"
                        Height="{StaticResource IconButtonSize}"
                        CornerRadius="{StaticResource FABCornerRadius}"
                        Margin="{StaticResource SmallLeftMargin}"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Padding="0">
                    <Button.Styles>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                            <Setter Property="Opacity" Value="0.9"/>
                        </Style>
                        <Style Selector="Button:pressed /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                            <Setter Property="Opacity" Value="0.8"/>
                        </Style>
                    </Button.Styles>
                    
                    <!-- 发送图标 -->
                    <Viewbox Width="{StaticResource SmallIconSize}" Height="{StaticResource SmallIconSize}">
                        <Canvas Width="24" Height="24">
                            <Path Fill="White" 
                                  Data="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </Canvas>
                    </Viewbox>
                </Button>
            </Grid>
        </Border>

        <!-- 对话消息列表 -->
        <ScrollViewer x:Name="ChatScrollViewer"
                      Margin="{StaticResource SmallMargin}">
            <ItemsControl ItemsSource="{Binding ChatMessages}"
                          Background="Transparent">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:ChatMessageAdapter">
                        <Border Padding="{StaticResource CompactCardPadding}" Margin="{StaticResource TinyLeftMargin}">
                            <StackPanel Spacing="{StaticResource TinySpacing}">
                                <!-- 时间戳 -->
                                <TextBlock Text="{Binding FormattedTime}" 
                                           FontSize="{StaticResource MiniFontSize}" 
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           HorizontalAlignment="Center" />
                                
                                <!-- 用户消息 -->
                                <Border Padding="{StaticResource SmallCardPadding}"
                                        Background="{DynamicResource PrimaryBrush}"
                                        HorizontalAlignment="Right"
                                        MaxWidth="{StaticResource MaxChatBubbleWidth}"
                                        CornerRadius="{StaticResource ChatBubbleUserCornerRadius}"
                                        IsVisible="{Binding IsUser}">
                                    <StackPanel Spacing="{StaticResource CompactSpacing}">
                                        <TextBlock Text="{Binding Sender}" 
                                                   FontSize="{StaticResource TinyFontSize}"
                                                   FontWeight="Bold"
                                                   Foreground="White" />
                                        <TextBlock Text="{Binding Content}" 
                                                  FontSize="{StaticResource LabelFontSize}"
                                                  TextWrapping="Wrap"
                                                  Foreground="White" />
                                    </StackPanel>
                                </Border>
                                
                                <!-- AI/系统消息 -->
                                <Border Padding="{StaticResource SmallCardPadding}"
                                        Background="{DynamicResource CardBackgroundBrush}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        BorderThickness="{StaticResource DefaultBorderThickness}"
                                        HorizontalAlignment="Left"
                                        MaxWidth="{StaticResource MaxChatBubbleWidth}"
                                        CornerRadius="{StaticResource ChatBubbleAssistantCornerRadius}"
                                        IsVisible="{Binding IsUser, Converter={x:Static BoolConverters.Not}}">
                                    <StackPanel Spacing="{StaticResource TinySpacing}">
                                        <TextBlock Text="{Binding Sender}" 
                                                   FontSize="{StaticResource TinyFontSize}"
                                                   FontWeight="Bold"
                                                   Foreground="{DynamicResource PrimaryBrush}" />
                                        
                                        <!-- 状态指示器 -->
                                        <StackPanel Orientation="Horizontal" 
                                                    Spacing="{StaticResource TinySpacing}"
                                                    IsVisible="{Binding Status, Converter={x:Static BoolConverters.Not}}">
                                            <ProgressBar IsIndeterminate="True"
                                                         Width="{StaticResource IndicatorSize}" 
                                                         Height="{StaticResource IndicatorSize}" />
                                            <TextBlock Text="正在思考..." 
                                                       FontSize="{StaticResource MiniFontSize}"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center" />
                                        </StackPanel>
                                        
                                        <!-- 内容区域 -->
                                        <controls:RichTextBlock Text="{Binding Content}" 
                                                               IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </DockPanel>
</UserControl>
