<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:models="using:MarketAssistant.Models"
             xmlns:controls="using:MarketAssistant.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="800"
             x:Class="MarketAssistant.Views.Components.AnalysisReportView"
             x:DataType="vm:AnalysisReportViewModel">

    <UserControl.Styles>
        <!-- å¡ç‰‡æ ‡é¢˜æ ·å¼ -->
        <Style Selector="TextBlock.section-title">
            <Setter Property="FontSize" Value="{StaticResource MediumFontSize}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="{StaticResource SmallBottomMargin}"/>
        </Style>
        
        <!-- æ ‡ç­¾æ ·å¼ -->
        <Style Selector="TextBlock.label">
            <Setter Property="FontSize" Value="{StaticResource SmallFontSize}"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
        </Style>
        
        <!-- å€¼æ ·å¼ -->
        <Style Selector="TextBlock.value">
            <Setter Property="FontSize" Value="{StaticResource SectionTitleFontSize}"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="{StaticResource TinyTopMargin}"/>
        </Style>
        
        <!-- åˆ—è¡¨é¡¹æ ·å¼ -->
        <Style Selector="TextBlock.list-item">
            <Setter Property="FontSize" Value="{StaticResource BodyFontSize}"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Margin" Value="{StaticResource TinyMargin}"/>
        </Style>
    </UserControl.Styles>

    <Grid>
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <ScrollViewer IsVisible="{Binding IsReportVisible}">
            <StackPanel Margin="{StaticResource DefaultMargin}" Spacing="{StaticResource DefaultSpacing}">
                
                <!-- 1. è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ -->
                <controls:CardView>
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="{StaticResource DefaultSpacing}">
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="è‚¡ç¥¨ä»£ç " Classes="label"/>
                            <TextBlock Text="{Binding StockSymbol}" Classes="value"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="ç›®æ ‡ä»·æ ¼" Classes="label"/>
                            <TextBlock Text="{Binding TargetPrice}" Classes="value"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="ä»·æ ¼é¢„æœŸ" Classes="label"/>
                            <TextBlock Text="{Binding PriceChangeExpectation}" 
                                       Classes="value"
                                       Foreground="{DynamicResource SuccessBrush}"/>
                        </StackPanel>
                        <StackPanel Grid.Column="3">
                            <TextBlock Text="æŠ•èµ„æœŸé™" Classes="label"/>
                            <TextBlock Text="{Binding TimeHorizon}" 
                                       Classes="value"
                                       Foreground="{DynamicResource PrimaryBrush}"/>
                        </StackPanel>
                    </Grid>
                </controls:CardView>

                <!-- 2. æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ç»„ -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="{StaticResource DefaultSpacing}">
                    <controls:CardView Grid.Column="0">
                        <StackPanel>
                            <TextBlock Text="æŠ•èµ„å»ºè®®" Classes="label"/>
                            <TextBlock Text="{Binding InvestmentRating}" 
                                       FontSize="{StaticResource LargeFontSize}" 
                                       FontWeight="Bold" 
                                       Margin="{StaticResource TinyMargin}"/>
                            <TextBlock Text="{Binding ConfidencePercentage, StringFormat='{}{0:F1}% ç½®ä¿¡åº¦'}" 
                                       FontSize="{StaticResource TinyFontSize}" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="1">
                        <StackPanel>
                            <TextBlock Text="é£Žé™©ç­‰çº§" Classes="label"/>
                            <TextBlock Text="{Binding RiskLevel}" 
                                       FontSize="{StaticResource LargeFontSize}" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource ErrorBrush}" 
                                       Margin="{StaticResource TinyMargin}"/>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="2">
                        <StackPanel>
                            <TextBlock Text="ç»¼åˆè¯„åˆ†" Classes="label"/>
                            <TextBlock Text="{Binding OverallScore}" 
                                       FontSize="{StaticResource LargeFontSize}" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource PrimaryBrush}" 
                                       Margin="{StaticResource TinyMargin}"/>
                            <TextBlock Text="{Binding ScorePercentage}" 
                                       FontSize="{StaticResource TinyFontSize}" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 3. æ“ä½œå»ºè®®ä¸Žç»´åº¦è¯„åˆ† -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource DefaultSpacing}">
                    <!-- æ“ä½œå»ºè®® -->
                    <controls:CardView Grid.Column="0">
                        <StackPanel Spacing="{StaticResource DefaultSpacing}">
                            <TextBlock Text="ðŸ“‹ æ“ä½œå»ºè®®" Classes="section-title"/>
                            <ItemsControl ItemsSource="{Binding OperationSuggestions}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <DockPanel Margin="{StaticResource TinyMargin}">
                                            <Ellipse DockPanel.Dock="Left"
                                                     Width="{StaticResource TinyIconSize}" 
                                                     Height="{StaticResource TinyIconSize}" 
                                                     Fill="{DynamicResource PrimaryBrush}" 
                                                     VerticalAlignment="Center"
                                                     Margin="{StaticResource SmallRightMargin}"/>
                                            <TextBlock Text="{Binding .}" 
                                                       Classes="list-item"
                                                       LineHeight="{StaticResource SmallIconSize}"/>
                                        </DockPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>

                    <!-- ç»´åº¦è¯„åˆ† -->
                    <controls:CardView Grid.Column="1">
                        <StackPanel Spacing="{StaticResource DefaultSpacing}">
                            <TextBlock Text="ðŸ“Š ç»´åº¦è¯„åˆ†" Classes="section-title"/>
                            <ItemsControl ItemsSource="{Binding DimensionScores}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="vm:ScoreItem">
                                        <StackPanel Margin="{StaticResource SmallTopMargin}" Spacing="{StaticResource TinySpacing}">
                                            <DockPanel LastChildFill="True">
                                                <TextBlock DockPanel.Dock="Right"
                                                           Text="{Binding FormattedScore}" 
                                                           FontWeight="Bold" 
                                                           FontSize="{StaticResource BodyFontSize}" 
                                                           Foreground="{DynamicResource PrimaryBrush}"
                                                           VerticalAlignment="Center"
                                                           Margin="{StaticResource DefaultLeftMargin}"/>
                                                <TextBlock Text="{Binding Name}" 
                                                           FontSize="{StaticResource BodyFontSize}" 
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center"/>
                                            </DockPanel>
                                            <ProgressBar Value="{Binding ScorePercentage}" 
                                                         Height="{StaticResource SmallSpacing}" 
                                                         Minimum="0" 
                                                         Maximum="1"
                                                         CornerRadius="{StaticResource TinyCornerRadius}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 4. æŠ•èµ„äº®ç‚¹ä¸Žé£Žé™©å› ç´  -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource DefaultSpacing}">
                    <controls:CardView Grid.Column="0">
                        <StackPanel Spacing="{StaticResource DefaultSpacing}">
                            <TextBlock Text="ðŸ’¡ æŠ•èµ„äº®ç‚¹" Classes="section-title"/>
                            <ItemsControl ItemsSource="{Binding InvestmentHighlights}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <DockPanel Margin="{StaticResource TinyMargin}">
                                            <Ellipse DockPanel.Dock="Left"
                                                     Width="{StaticResource TinyIconSize}" 
                                                     Height="{StaticResource TinyIconSize}" 
                                                     Fill="{DynamicResource SuccessBrush}" 
                                                     VerticalAlignment="Center" 
                                                     Margin="{StaticResource SmallRightMargin}"/>
                                            <TextBlock Text="{Binding .}" 
                                                       Classes="list-item"/>
                                        </DockPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="1">
                        <StackPanel Spacing="{StaticResource DefaultSpacing}">
                            <TextBlock Text="âš ï¸ é£Žé™©å› ç´ " Classes="section-title"/>
                            <ItemsControl ItemsSource="{Binding RiskFactors}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <DockPanel Margin="{StaticResource TinyMargin}">
                                            <Ellipse DockPanel.Dock="Left"
                                                     Width="{StaticResource TinyIconSize}" 
                                                     Height="{StaticResource TinyIconSize}" 
                                                     Fill="{DynamicResource ErrorBrush}" 
                                                     VerticalAlignment="Center" 
                                                     Margin="{StaticResource SmallRightMargin}"/>
                                            <TextBlock Text="{Binding .}" 
                                                       Classes="list-item"/>
                                        </DockPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 5. åˆ†æžå¸ˆå…±è¯†ä¸Žåˆ†æ­§ -->
                <Grid ColumnDefinitions="*,*" 
                      ColumnSpacing="{StaticResource DefaultSpacing}" 
                      IsVisible="{Binding HasConsensusAnalysis}">
                    <controls:CardView Grid.Column="0" 
                                       IsVisible="{Binding HasConsensusAnalysis}">
                        <StackPanel Spacing="{StaticResource DefaultSpacing}">
                            <TextBlock Text="ðŸ¤ æ ¸å¿ƒå…±è¯†" Classes="section-title"/>
                            <TextBlock Text="{Binding ConsensusAnalysis}" 
                                       FontSize="{StaticResource BodyFontSize}"
                                       TextWrapping="Wrap"
                                       LineHeight="{StaticResource SmallIconSize}"/>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="1" 
                                       IsVisible="{Binding HasDisagreementAnalysis}">
                        <StackPanel Spacing="{StaticResource DefaultSpacing}">
                            <TextBlock Text="ðŸ’­ ä¸»è¦åˆ†æ­§åŠåˆ¤æ–­" Classes="section-title"/>
                            <TextBlock Text="{Binding DisagreementAnalysis}" 
                                       FontSize="{StaticResource BodyFontSize}"
                                       TextWrapping="Wrap"
                                       LineHeight="{StaticResource SmallIconSize}"/>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 6. åè°ƒåˆ†æžå¸ˆç»¼åˆæŠ¥å‘Šï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ -->
                <controls:CardView>
                    <StackPanel Spacing="{StaticResource DefaultSpacing}">
                        <TextBlock Text="ðŸ“Š åè°ƒåˆ†æžå¸ˆç»¼åˆæŠ¥å‘Š" Classes="section-title"/>
                        <TextBlock Text="{Binding CoordinatorSummary}" 
                                   FontSize="{StaticResource BodyFontSize}"
                                   TextWrapping="Wrap"
                                   LineHeight="{StaticResource SmallIconSize}"/>
                    </StackPanel>
                </controls:CardView>
            </StackPanel>
        </ScrollViewer>
        
        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <Border IsVisible="{Binding IsBusy}" 
                Background="{StaticResource OverlayBrush}"
                ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center" 
                        Spacing="{StaticResource LargeSpacing}">
                <ProgressBar IsIndeterminate="True" 
                             Width="{StaticResource AppLogoSize}" 
                             Height="{StaticResource AppLogoSize}"/>
                <TextBlock Text="æ­£åœ¨è§£æžåˆ†æžæ•°æ®..." 
                           FontSize="{StaticResource MediumFontSize}" 
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
