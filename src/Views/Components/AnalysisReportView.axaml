<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:models="using:MarketAssistant.Models"
             xmlns:controls="using:MarketAssistant.Views.Controls"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="800"
             x:Class="MarketAssistant.Views.Components.AnalysisReportView"
             x:DataType="vm:AnalysisReportViewModel">

    <UserControl.Styles>
        <!-- å¡ç‰‡æ ‡é¢˜æ ·å¼ -->
        <Style Selector="TextBlock.SectionTitle">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>
        
        <!-- æ ‡ç­¾æ ·å¼ -->
        <Style Selector="TextBlock.Label">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
        </Style>
        
        <!-- å€¼æ ·å¼ -->
        <Style Selector="TextBlock.Value">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>
        
        <!-- åˆ—è¡¨é¡¹æ ·å¼ -->
        <Style Selector="TextBlock.ListItem">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="Margin" Value="0,4"/>
        </Style>
    </UserControl.Styles>

    <Grid>
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <ScrollViewer IsVisible="{Binding IsReportVisible}">
            <StackPanel Margin="12" Spacing="12">
                
                <!-- 1. è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ -->
                <controls:CardView>
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="12">
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="è‚¡ç¥¨ä»£ç " Classes="Label"/>
                            <TextBlock Text="{Binding StockSymbol}" Classes="Value"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="ç›®æ ‡ä»·æ ¼" Classes="Label"/>
                            <TextBlock Text="{Binding TargetPrice}" Classes="Value"/>
                        </StackPanel>
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="ä»·æ ¼é¢„æœŸ" Classes="Label"/>
                            <TextBlock Text="{Binding PriceChangeExpectation}" 
                                       Classes="Value"
                                       Foreground="{DynamicResource SuccessBrush}"/>
                        </StackPanel>
                        <StackPanel Grid.Column="3">
                            <TextBlock Text="æŠ•èµ„æœŸé™" Classes="Label"/>
                            <TextBlock Text="{Binding TimeHorizon}" 
                                       Classes="Value"
                                       Foreground="{DynamicResource PrimaryBrush}"/>
                        </StackPanel>
                    </Grid>
                </controls:CardView>

                <!-- 2. æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ç»„ -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                    <controls:CardView Grid.Column="0">
                        <StackPanel>
                            <TextBlock Text="æŠ•èµ„å»ºè®®" Classes="Label"/>
                            <TextBlock Text="{Binding InvestmentRating}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Margin="0,4"/>
                            <TextBlock Text="{Binding ConfidencePercentage, StringFormat='{}{0:F1}% ç½®ä¿¡åº¦'}" 
                                       FontSize="11" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="1">
                        <StackPanel>
                            <TextBlock Text="é£Žé™©ç­‰çº§" Classes="Label"/>
                            <TextBlock Text="{Binding RiskLevel}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource ErrorBrush}" 
                                       Margin="0,4"/>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="2">
                        <StackPanel>
                            <TextBlock Text="ç»¼åˆè¯„åˆ†" Classes="Label"/>
                            <TextBlock Text="{Binding OverallScore}" 
                                       FontSize="20" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource PrimaryBrush}" 
                                       Margin="0,4"/>
                            <TextBlock Text="{Binding ScorePercentage}" 
                                       FontSize="11" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 3. æ“ä½œå»ºè®®ä¸Žç»´åº¦è¯„åˆ† -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <!-- æ“ä½œå»ºè®® -->
                    <controls:CardView Grid.Column="0">
                        <StackPanel Spacing="12">
                            <TextBlock Text="ðŸ“‹ æ“ä½œå»ºè®®" Classes="SectionTitle"/>
                            <ItemsControl ItemsSource="{Binding OperationSuggestions}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <Grid ColumnDefinitions="Auto,*" Margin="0,4">
                                            <Ellipse Width="6" 
                                                     Height="6" 
                                                     Fill="{DynamicResource PrimaryBrush}" 
                                                     VerticalAlignment="Top"
                                                     Margin="0,6,8,0"/>
                                            <TextBlock Grid.Column="1" 
                                                       Text="{Binding .}" 
                                                       Classes="ListItem"
                                                       LineHeight="20"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>

                    <!-- ç»´åº¦è¯„åˆ† -->
                    <controls:CardView Grid.Column="1">
                        <StackPanel Spacing="12">
                            <TextBlock Text="ðŸ“Š ç»´åº¦è¯„åˆ†" Classes="SectionTitle"/>
                            <ItemsControl ItemsSource="{Binding DimensionScores}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:ScoreItem">
                                        <StackPanel Margin="0,8,0,0" Spacing="6">
                                            <Grid ColumnDefinitions="*,60" ColumnSpacing="12">
                                                <TextBlock Text="{Binding Name}" 
                                                           FontSize="13" 
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center"/>
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding FormattedScore}" 
                                                           FontWeight="Bold" 
                                                           FontSize="13" 
                                                           Foreground="{DynamicResource PrimaryBrush}"
                                                           HorizontalAlignment="Right"
                                                           VerticalAlignment="Center"/>
                                            </Grid>
                                            <ProgressBar Value="{Binding ScorePercentage}" 
                                                         Height="8" 
                                                         Minimum="0" 
                                                         Maximum="1"
                                                         CornerRadius="4"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 4. æŠ•èµ„äº®ç‚¹ä¸Žé£Žé™©å› ç´  -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <controls:CardView Grid.Column="0">
                        <StackPanel Spacing="12">
                            <TextBlock Text="ðŸ’¡ æŠ•èµ„äº®ç‚¹" Classes="SectionTitle"/>
                            <ItemsControl ItemsSource="{Binding InvestmentHighlights}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <Grid ColumnDefinitions="Auto,*" Margin="0,4">
                                            <Ellipse Width="6" 
                                                     Height="6" 
                                                     Fill="{DynamicResource SuccessBrush}" 
                                                     VerticalAlignment="Center" 
                                                     Margin="0,0,8,0"/>
                                            <TextBlock Grid.Column="1" 
                                                       Text="{Binding .}" 
                                                       Classes="ListItem"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="1">
                        <StackPanel Spacing="12">
                            <TextBlock Text="âš ï¸ é£Žé™©å› ç´ " Classes="SectionTitle"/>
                            <ItemsControl ItemsSource="{Binding RiskFactors}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <Grid ColumnDefinitions="Auto,*" Margin="0,4">
                                            <Ellipse Width="6" 
                                                     Height="6" 
                                                     Fill="{DynamicResource ErrorBrush}" 
                                                     VerticalAlignment="Center" 
                                                     Margin="0,0,8,0"/>
                                            <TextBlock Grid.Column="1" 
                                                       Text="{Binding .}" 
                                                       Classes="ListItem"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 5. åˆ†æžå¸ˆå…±è¯†ä¸Žåˆ†æ­§ -->
                <Grid ColumnDefinitions="*,*" 
                      ColumnSpacing="12" 
                      IsVisible="{Binding HasConsensusAnalysis}">
                    <controls:CardView Grid.Column="0" 
                                       IsVisible="{Binding HasConsensusAnalysis}">
                        <StackPanel Spacing="12">
                            <TextBlock Text="ðŸ¤ æ ¸å¿ƒå…±è¯†" Classes="SectionTitle"/>
                            <TextBlock Text="{Binding ConsensusAnalysis}" 
                                       FontSize="13"
                                       TextWrapping="Wrap"
                                       LineHeight="20"/>
                        </StackPanel>
                    </controls:CardView>

                    <controls:CardView Grid.Column="1" 
                                       IsVisible="{Binding HasDisagreementAnalysis}">
                        <StackPanel Spacing="12">
                            <TextBlock Text="ðŸ’­ ä¸»è¦åˆ†æ­§åŠåˆ¤æ–­" Classes="SectionTitle"/>
                            <TextBlock Text="{Binding DisagreementAnalysis}" 
                                       FontSize="13"
                                       TextWrapping="Wrap"
                                       LineHeight="20"/>
                        </StackPanel>
                    </controls:CardView>
                </Grid>

                <!-- 6. åè°ƒåˆ†æžå¸ˆç»¼åˆæŠ¥å‘Šï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ -->
                <controls:CardView>
                    <StackPanel Spacing="12">
                        <TextBlock Text="ðŸ“Š åè°ƒåˆ†æžå¸ˆç»¼åˆæŠ¥å‘Š" Classes="SectionTitle"/>
                        <TextBlock Text="{Binding CoordinatorSummary}" 
                                   FontSize="13"
                                   TextWrapping="Wrap"
                                   LineHeight="20"/>
                    </StackPanel>
                </controls:CardView>
            </StackPanel>
        </ScrollViewer>
        
        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <Border IsVisible="{Binding IsBusy}" 
                Background="#E0FFFFFF"
                ZIndex="1000">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center" 
                        Spacing="16">
                <ProgressBar IsIndeterminate="True" 
                             Width="48" 
                             Height="48"/>
                <TextBlock Text="æ­£åœ¨è§£æžåˆ†æžæ•°æ®..." 
                           FontSize="15" 
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
