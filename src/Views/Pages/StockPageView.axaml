<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:controls="using:MarketAssistant.Views.Controls"
			 xmlns:components="using:MarketAssistant.Views.Components"
             xmlns:converts="using:MarketAssistant.Converts"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="MarketAssistant.Views.Pages.StockPageView"
             x:DataType="vm:StockPageViewModel">

    <Design.DataContext>
        <vm:StockPageViewModel/>
    </Design.DataContext>

    <UserControl.Resources>
        <converts:PriceChangeColorConverter x:Key="PriceChangeColorConverter"/>
    </UserControl.Resources>

    <Grid Margin="{StaticResource PagePadding}" RowDefinitions="Auto,*">
        
        <!-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
        <controls:CardView Grid.Row="0" Padding="{StaticResource CardPadding}">
            <Grid ColumnDefinitions="*,Auto">
                
                <!-- å·¦ä¾§ï¼šè‚¡ç¥¨ä¿¡æ¯ï¼ˆGridå¸ƒå±€ä¼˜åŒ–ï¼‰ -->
                <Grid Grid.Column="0" ColumnDefinitions="Auto,Auto" RowDefinitions="Auto,Auto,Auto" VerticalAlignment="Center">
                    <!-- ç¬¬ä¸€è¡Œï¼šåç§°ä¸Žä»£ç  -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" 
                                Orientation="Horizontal" Spacing="{StaticResource SmallSpacing}" 
                                Margin="{StaticResource SmallBottomMargin}">
                        <TextBlock Text="{Binding StockName}" 
                                   FontSize="{StaticResource LargeFontSize}"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource InfoBrush}" 
                                CornerRadius="{StaticResource TinyCornerRadius}" 
                                Padding="{StaticResource TinyPadding}"
                                VerticalAlignment="Center">
                            <TextBlock Text="{Binding StockCode}" 
                                       FontSize="{StaticResource TinyFontSize}" 
                                       FontWeight="Bold" 
                                       Foreground="White" />
                        </Border>
                    </StackPanel>
                    
                    <!-- ç¬¬äºŒè¡Œ/ç¬¬ä¸‰è¡Œå·¦ä¾§ï¼šä»·æ ¼ -->
                    <TextBlock Grid.Row="1" Grid.RowSpan="2" Grid.Column="0"
                               Text="{Binding CurrentPrice, StringFormat={}{0:F2}}" 
                               FontSize="{StaticResource TitleFontSize}"
                               FontWeight="Bold"
                               Foreground="{Binding PriceChange, Converter={StaticResource PriceChangeColorConverter}}"
                               LineHeight="{StaticResource TitleFontSize}"
                               VerticalAlignment="Center"
                               Margin="{StaticResource RightMargin}"/>
                         
                    <!-- ç¬¬äºŒè¡Œå³ä¾§ï¼šæ¶¨è·Œå¹… -->
                    <StackPanel Grid.Row="1" Grid.Column="1" 
                                Orientation="Horizontal" Spacing="{StaticResource TinySpacing}" 
                                VerticalAlignment="Bottom"
                                Margin="{StaticResource TinyBottomMargin}">
                         <TextBlock FontSize="{StaticResource LabelFontSize}" 
                                    FontWeight="Bold"
                                    Text="{Binding PriceChange, StringFormat={}{0:F2}}"
                                    Foreground="{Binding PriceChange, Converter={StaticResource PriceChangeColorConverter}}" />
                         <TextBlock FontSize="{StaticResource LabelFontSize}" 
                                    FontWeight="Bold"
                                    Text="{Binding PriceChangePercent, StringFormat={}({0:F2}%)}"
                                    Foreground="{Binding PriceChange, Converter={StaticResource PriceChangeColorConverter}}" />
                    </StackPanel>
                    
                    <!-- ç¬¬ä¸‰è¡Œå³ä¾§ï¼šæ ‡ç­¾ -->
                    <TextBlock Grid.Row="2" Grid.Column="1"
                               Text="è¾ƒæ˜¨æ”¶" 
                               FontSize="{StaticResource TinyFontSize}" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Top"/>
                </Grid>
                
                <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’®ç»„ -->
                <StackPanel Grid.Column="1" 
                            Orientation="Horizontal" 
                            Spacing="{StaticResource SmallSpacing}"
                            VerticalAlignment="Center">
                    <!-- AIåˆ†æžæŒ‰é’® -->
                    <Button Classes="action-button"
                            Command="{Binding NavigateToAnalysisCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="{StaticResource TinySpacing}">
                            <TextBlock Text="ðŸ¤–"/>
                            <TextBlock Text="AIåˆ†æž"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- åˆ·æ–°æŒ‰é’® -->
                    <Button Classes="action-button"
                            Command="{Binding RefreshDataCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="{StaticResource TinySpacing}">
                            <TextBlock Text="ðŸ”„"/>
                            <TextBlock Text="åˆ·æ–°"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </controls:CardView>

        <!-- Kçº¿å›¾è¡¨åŒºåŸŸ - åªåœ¨æ— é”™è¯¯æ—¶æ˜¾ç¤º -->
        <controls:CardView Grid.Row="1" 
                          Margin="{StaticResource TopMargin}"
                          IsVisible="{Binding !HasError}">
            <Grid RowDefinitions="Auto,*">

                <!-- å›¾è¡¨æŽ§åˆ¶åŒºåŸŸ -->
                <Grid Grid.Row="0" 
                      Margin="{StaticResource BottomMargin}"
                      ColumnDefinitions="Auto,*,Auto">
                    
                    <!-- å›¾ä¾‹ -->
                    <StackPanel Grid.Column="0" 
                                Orientation="Horizontal" 
                                Spacing="{StaticResource DefaultSpacing}"
                                VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="{StaticResource TinySpacing}" VerticalAlignment="Center">
                            <Border Background="{DynamicResource SuccessBrush}" 
                                    Width="{StaticResource IndicatorSize}" 
                                    Height="{StaticResource IndicatorSize}" 
                                    CornerRadius="{StaticResource TinyCornerRadius}" />
                            <TextBlock Text="ä¸Šæ¶¨" 
                                       FontSize="{StaticResource SmallFontSize}" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="{StaticResource TinySpacing}" VerticalAlignment="Center">
                            <Border Background="{DynamicResource ErrorBrush}" 
                                    Width="{StaticResource IndicatorSize}" 
                                    Height="{StaticResource IndicatorSize}" 
                                    CornerRadius="{StaticResource TinyCornerRadius}" />
                            <TextBlock Text="ä¸‹è·Œ" 
                                       FontSize="{StaticResource SmallFontSize}" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>

                    <!-- æ—¶é—´å‘¨æœŸæŒ‰é’®ç»„ -->
                    <Border Grid.Column="2" 
                            Background="{DynamicResource SurfaceVariantBrush}"
                            CornerRadius="{StaticResource SmallCornerRadius}"
                            Padding="{StaticResource TinyPadding}">
                        <StackPanel Orientation="Horizontal" Spacing="0">
                            <Button Content="åˆ†æ—¶" 
                                    Classes="period-button"
                                    Classes.selected="{Binding IsMinuteSelected}"
                                    Command="{Binding ChangeKLineTypeCommand}" 
                                    CommandParameter="minute" />

                            <Button Content="æ—¥K" 
                                    Classes="period-button"
                                    Classes.selected="{Binding IsDailySelected}"
                                    Command="{Binding ChangeKLineTypeCommand}" 
                                    CommandParameter="daily" />

                            <Button Content="å‘¨K" 
                                    Classes="period-button"
                                    Classes.selected="{Binding IsWeeklySelected}"
                                    Command="{Binding ChangeKLineTypeCommand}" 
                                    CommandParameter="weekly" />

                            <Button Content="æœˆK" 
                                    Classes="period-button"
                                    Classes.selected="{Binding IsMonthlySelected}"
                                    Command="{Binding ChangeKLineTypeCommand}" 
                                    CommandParameter="monthly" />
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- å›¾è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
                <Grid Grid.Row="1">
                    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                    <StackPanel HorizontalAlignment="Center" 
                                VerticalAlignment="Center"
                                IsVisible="{Binding IsBusy}">
                        <TextBlock Text="â³" FontSize="{StaticResource LargeIconSize}" HorizontalAlignment="Center"/>
                        <TextBlock Text="æ­£åœ¨åŠ è½½Kçº¿æ•°æ®..." 
                                   FontSize="{StaticResource LabelFontSize}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   Margin="{StaticResource DefaultMargin}"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>

                    <!-- Kçº¿å›¾è¡¨ -->
					<components:StockWebChartView x:Name="WebChartView" 
                                               Data="{Binding KLineData}"
                                               IsVisible="{Binding !IsBusy}" />
                </Grid>
            </Grid>
        </controls:CardView>
        
        <!-- é”™è¯¯çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
        <controls:CardView Grid.Row="1" 
                          Margin="{StaticResource TopMargin}"
                          IsVisible="{Binding HasError}">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center" 
                        Spacing="{StaticResource DefaultSpacing}">
                <TextBlock Text="âš ï¸" 
                           FontSize="{StaticResource LargeIconSize}" 
                           HorizontalAlignment="Center" />
                <TextBlock Text="æ•°æ®åŠ è½½å¤±è´¥" 
                           FontSize="{StaticResource SubTitleFontSize}"
                           FontWeight="Bold"
                           Foreground="{DynamicResource ErrorBrush}"
                           HorizontalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}" 
                           FontSize="{StaticResource LabelFontSize}"
                           Foreground="{DynamicResource ErrorBrush}"
                           HorizontalAlignment="Center" 
                           TextAlignment="Center"
                           MaxWidth="{StaticResource MaxDialogWidth}"
                           TextWrapping="Wrap" />
            </StackPanel>
        </controls:CardView>
    </Grid>
</UserControl>
