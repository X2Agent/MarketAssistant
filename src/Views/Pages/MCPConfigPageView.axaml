<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:settings="using:MarketAssistant.Applications.Settings"
             xmlns:controls="using:MarketAssistant.Views.Controls"
             xmlns:converts="using:MarketAssistant.Converts"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="MarketAssistant.Views.Pages.MCPConfigPageView"
             x:DataType="vm:MCPConfigPageViewModel">

    <UserControl.Resources>
        <converts:RadioButtonEqualityConverter x:Key="RadioButtonEqualityConverter"/>
    </UserControl.Resources>

    <Design.DataContext>
        <vm:MCPConfigPageViewModel/>
    </Design.DataContext>

    <Grid ColumnDefinitions="300,*">
        <!-- 左侧服务器列表 -->
        <Border Grid.Column="0" 
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,1,0"
                Padding="16">
            <Grid RowDefinitions="Auto,*">
                <!-- 添加服务器按钮 -->
                <Button Grid.Row="0" 
                        Content="添加服务器" 
                        Command="{Binding AddServerCommand}" 
                        Background="{StaticResource SuccessBrush}"
                        Foreground="White"
                        HorizontalAlignment="Stretch"
                        Margin="0,0,0,12" />

                <!-- 服务器列表 -->
                <ScrollViewer Grid.Row="1">
                    <ItemsControl ItemsSource="{Binding ServerConfigs}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="settings:MCPServerConfig">
                                <Border Background="{DynamicResource ItemBackgroundBrush}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="6"
                                        Padding="12"
                                        Margin="0,0,0,8"
                                        Cursor="Hand"
                                        Tapped="OnServerItemTapped"
                                        Tag="{Binding .}">

                                    <Grid RowDefinitions="Auto,Auto,Auto">
                                        <TextBlock Grid.Row="0"
                                                   Text="{Binding Name}" 
                                                   FontWeight="Bold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <TextBlock Grid.Row="1"
                                                   Text="{Binding Description}" 
                                                   FontSize="12" 
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   TextTrimming="CharacterEllipsis"
                                                   Margin="0,4,0,0"/>
                                        <StackPanel Grid.Row="2"
                                                    Orientation="Horizontal"
                                                    Spacing="8"
                                                    Margin="0,4,0,0">
                                            <TextBlock Text="{Binding TransportType}" 
                                                       FontSize="10" 
                                                       Foreground="{StaticResource PrimaryBrush}"/>
                                            <TextBlock Text="{Binding IsEnabled, StringFormat={}{0}启用}" 
                                                       FontSize="10" 
                                                       Foreground="{StaticResource SuccessBrush}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- 空视图 -->
                <Grid Grid.Row="1"
                      RowDefinitions="Auto,Auto"
                      IsVisible="{Binding !ServerConfigs.Count}"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center">
                    <TextBlock Grid.Row="0"
                               Text="暂无服务器配置" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center"/>
                    <TextBlock Grid.Row="1"
                               Text="点击上方按钮添加" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,8,0,0"/>
                </Grid>
            </Grid>
        </Border>

        <!-- 右侧配置详情 -->
        <Grid Grid.Column="1" RowDefinitions="*,Auto">
            <!-- 编辑表单区域 -->
            <ScrollViewer Grid.Row="0" Padding="16">
                <StackPanel IsVisible="{Binding IsEditing}" Spacing="16">
                    <!-- 基本信息 -->
                    <controls:CardView Header="基本信息">
                        <StackPanel Spacing="12">
                            <!-- 服务器名称 -->
                            <StackPanel Spacing="8">
                                <TextBlock FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="*" Foreground="#dc3545"/>
                                    <Run Text="名称"/>
                                </TextBlock>
                                <TextBox Text="{Binding Name}" Watermark="请输入服务器名称"/>
                            </StackPanel>

                            <!-- 服务器描述 -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="描述" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBox Text="{Binding Description}" 
                                         Watermark="请输入服务器描述"
                                         Height="100"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"/>
                            </StackPanel>

                            <!-- 服务器类型 -->
                            <StackPanel Spacing="8">
                                <TextBlock FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="*" Foreground="#dc3545"/>
                                    <Run Text="类型"/>
                                </TextBlock>
                                <StackPanel Orientation="Horizontal" Spacing="16">
                                    <RadioButton GroupName="transportType" 
                                                 Content="标准输入/输出(stdio)"
                                                 IsChecked="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=stdio}"/>
                                    <RadioButton GroupName="transportType" 
                                                 Content="服务器发送事件(sse)"
                                                 IsChecked="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=sse}"/>
                                    <RadioButton GroupName="transportType" 
                                                 Content="可流式传输的HTTP(streamableHttp)"
                                                 IsChecked="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=streamableHttp}"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- 命令/URL配置 (stdio) -->
                            <StackPanel Spacing="8" IsVisible="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=stdio}">
                                <TextBlock FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="*" Foreground="#dc3545"/>
                                    <Run Text="命令"/>
                                </TextBlock>
                                <TextBox Text="{Binding Command}" Watermark="请输入命令，如 npx"/>
                            </StackPanel>

                            <!-- 命令/URL配置 (sse) -->
                            <StackPanel Spacing="8" IsVisible="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=sse}">
                                <TextBlock FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="*" Foreground="{StaticResource ErrorBrush}"/>
                                    <Run Text="URL"/>
                                </TextBlock>
                                <TextBox Text="{Binding Command}" Watermark="请输入 URL，如 http://localhost:3000/sse"/>
                                <TextBlock Text="提示：URL示例 http://localhost:3000/sse" 
                                           FontSize="12" 
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>

                            <!-- 命令/URL配置 (streamableHttp) -->
                            <StackPanel Spacing="8" IsVisible="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=streamableHttp}">
                                <TextBlock FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="*" Foreground="{StaticResource ErrorBrush}"/>
                                    <Run Text="URL"/>
                                </TextBlock>
                                <TextBox Text="{Binding Command}" Watermark="请输入 URL，如 http://localhost:3000/mcp"/>
                                <TextBlock Text="提示：URL示例 http://localhost:3000/mcp" 
                                           FontSize="12" 
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>

                            <!-- 参数配置 (仅stdio) -->
                            <StackPanel Spacing="8" IsVisible="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=stdio}">
                                <TextBlock Text="参数" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBox Text="{Binding Arguments}" 
                                         Watermark="请输入命令参数，如-y @modelcontextprotocol/server-github"
                                         Height="100"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"/>
                                <TextBlock Text="提示：多个参数请用空格分隔" 
                                           FontSize="12" 
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>

                            <!-- 环境变量配置 (仅stdio) -->
                            <StackPanel Spacing="8" IsVisible="{Binding TransportType, Converter={StaticResource RadioButtonEqualityConverter}, ConverterParameter=stdio}">
                                <TextBlock Text="环境变量" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBox Text="{Binding EnvironmentVariablesText}"
                                         Watermark="KEY1=value1&#10;KEY2=value2"
                                         Height="150"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"/>
                                <TextBlock Text="每行一个环境变量，格式为KEY=value" 
                                           FontSize="12" 
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>

                            <!-- 是否启用 -->
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <CheckBox IsChecked="{Binding IsEnabled}"/>
                                <TextBlock Text="启用" 
                                           FontSize="14" 
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </controls:CardView>
                </StackPanel>
            </ScrollViewer>

            <!-- 操作按钮区域 (固定在底部) -->
            <Border Grid.Row="1"
                    IsVisible="{Binding IsEditing}"
                    Background="{DynamicResource CardBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,1,0,0"
                    Padding="16,12">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- 测试状态显示 -->
                    <StackPanel Grid.Column="0" 
                                Orientation="Horizontal" 
                                Spacing="8"
                                VerticalAlignment="Center"
                                IsVisible="{Binding IsTesting}">
                        <ProgressBar IsIndeterminate="True" 
                                     Width="80" 
                                     Height="4"
                                     VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding TestStatus}" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <TextBlock Grid.Column="0"
                               Text="{Binding TestStatus}"
                               Foreground="{DynamicResource SuccessBrush}"
                               VerticalAlignment="Center"
                               IsVisible="{Binding !IsTesting}"/>
                    
                    <!-- 按钮组 -->
                    <StackPanel Grid.Column="1" 
                                Orientation="Horizontal" 
                                Spacing="12">
                        <Button Content="取消" 
                                Command="{Binding CancelEditCommand}"
                                MinWidth="100"
                                Padding="16,8"/>
                        <Button Content="删除" 
                                Command="{Binding DeleteServerCommand}"
                                Background="{StaticResource ErrorBrush}"
                                Foreground="White"
                                MinWidth="100"
                                Padding="16,8"
                                IsVisible="{Binding SelectedConfig, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                        <Button Content="测试连接" 
                                Command="{Binding TestConnectionCommand}"
                                IsEnabled="{Binding !IsTesting}"
                                Background="{StaticResource InfoBrush}"
                                Foreground="White"
                                MinWidth="100"
                                Padding="16,8"/>
                        <Button Content="保存" 
                                Command="{Binding SaveServerCommand}"
                                IsEnabled="{Binding !IsTesting}"
                                Background="{StaticResource PrimaryBrush}"
                                Foreground="White"
                                MinWidth="100"
                                Padding="16,8"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 删除确认对话框 -->
            <Border Grid.Row="0" Grid.RowSpan="2"
                    IsVisible="{Binding ShowDeleteConfirmation}"
                    Background="{DynamicResource CardBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Width="400"
                    Height="200"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    BoxShadow="0 4 16 0 #33000000"
                    Padding="16">
                <Grid RowDefinitions="Auto,Auto,Auto" VerticalAlignment="Center">
                    <TextBlock Grid.Row="0"
                               Text="确认删除" 
                               FontSize="18" 
                               FontWeight="Bold" 
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBlock Grid.Row="1"
                               Text="确定要删除此服务器配置吗？此操作无法撤销。" 
                               HorizontalAlignment="Center"
                               TextWrapping="Wrap"
                               TextAlignment="Center"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               Margin="0,16,0,0"/>
                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal" 
                                HorizontalAlignment="Center" 
                                Spacing="16"
                                Margin="0,16,0,0">
                        <Button Content="取消" 
                                Command="{Binding CancelDeleteCommand}" 
                                Background="{DynamicResource SubtleFillColorSecondaryBrush}"
                                Foreground="{DynamicResource TextPrimaryBrush}"
                                Width="120"/>
                        <Button Content="删除" 
                                Command="{Binding ConfirmDeleteCommand}" 
                                Background="#dc3545"
                                Foreground="White"
                                Width="120"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 未选择服务器时的提示 -->
            <StackPanel Grid.Row="0" Grid.RowSpan="2"
                        IsVisible="{Binding IsEditing, Converter={x:Static BoolConverters.Not}}"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="16">
                <TextBlock Text="请选择或添加MCP服务器" 
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="18"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
