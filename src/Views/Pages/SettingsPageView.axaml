<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MarketAssistant.ViewModels"
             xmlns:controls="using:MarketAssistant.Views.Controls"
             xmlns:converts="using:MarketAssistant.Converts"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="MarketAssistant.Views.Pages.SettingsPageView"
             x:DataType="vm:SettingsPageViewModel">

    <UserControl.Resources>
        <converts:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
    </UserControl.Resources>

    <Design.DataContext>
        <vm:SettingsPageViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="*,Auto">
        <!-- 主内容区域 -->
        <ScrollViewer Grid.Row="0" Grid.RowSpan="2" Background="{DynamicResource CardBackgroundBrush}">
            <StackPanel Spacing="{StaticResource DefaultSpacing}" Margin="{StaticResource ImmersivePageMargin}">

                <!-- 模型设置区域 -->
                <controls:CardView Header="模型设置(硅基流动)">
                    <StackPanel Spacing="{StaticResource DefaultSpacing}">
                        <!-- 模型选择 -->
                        <ComboBox ItemsSource="{Binding Models}"
                                  SelectedItem="{Binding UserSetting.ModelId}"
                                  PlaceholderText="模型选择"
                                  HorizontalAlignment="Stretch"
                                  IsEnabled="{Binding Models.Count}"/>

                        <!-- API密钥 -->
                        <StackPanel Spacing="{StaticResource SmallSpacing}">
                            <TextBlock Text="API密钥"
                                       FontSize="{StaticResource LabelFontSize}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Grid.Column="0"
                                         Text="{Binding UserSetting.ApiKey}"
                                         Watermark="请输入API密钥"
                                         PasswordChar="●"/>
                                <Button Grid.Column="1"
                                        Content="获取密钥"
                                        Command="{Binding OpenModelApiWebsiteCommand}"
                                        Background="{DynamicResource PrimaryBrush}"
                                        Foreground="White"
                                        Margin="{StaticResource SmallLeftMargin}"/>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </controls:CardView>

                <!-- API令牌设置区域 -->
                <controls:CardView Header="API令牌设置">
                    <StackPanel Spacing="{StaticResource SmallSpacing}">
                        <TextBlock Text="ZhiTu API令牌"
                                   FontSize="{StaticResource LabelFontSize}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding UserSetting.ZhiTuApiToken}"
                                     Watermark="请输入ZhiTu API令牌"/>
                            <Button Grid.Column="1"
                                    Content="获取令牌"
                                    Command="{Binding OpenZhiTuApiWebsiteCommand}"
                                    Background="{DynamicResource InfoBrush}"
                                    Foreground="White"
                                    Margin="{StaticResource SmallLeftMargin}"/>
                        </Grid>
                    </StackPanel>
                </controls:CardView>

                <!-- 投资偏好设置 -->
                <controls:CardView Header="投资偏好设置">
                    <Grid ColumnDefinitions="*,16,*">
                        <!-- 风险承受能力 -->
                        <StackPanel Grid.Column="0" Spacing="{StaticResource SmallSpacing}">
                            <TextBlock Text="风险承受能力"
                                       FontSize="{StaticResource LabelFontSize}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <ComboBox ItemsSource="{Binding RiskToleranceOptions}"
                                      SelectedItem="{Binding UserSetting.InvestmentPreference.RiskTolerance}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>

                        <!-- 投资期限 -->
                        <StackPanel Grid.Column="2" Spacing="{StaticResource SmallSpacing}">
                            <TextBlock Text="投资期限"
                                       FontSize="{StaticResource LabelFontSize}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <ComboBox ItemsSource="{Binding InvestmentHorizonOptions}"
                                      SelectedItem="{Binding UserSetting.InvestmentPreference.InvestmentHorizon}"
                                      HorizontalAlignment="Stretch">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                    </Grid>
                </controls:CardView>

                <!-- 知识库设置区域 -->
                <controls:CardView Header="知识库设置">
                    <StackPanel Spacing="{StaticResource DefaultSpacing}">
                        <!-- 是否加载知识库 -->
                        <CheckBox IsChecked="{Binding UserSetting.LoadKnowledge}"
                                  Content="加载知识库"/>

                        <StackPanel Spacing="{StaticResource DefaultSpacing}" 
                                    IsEnabled="{Binding UserSetting.LoadKnowledge}">
                            <!-- 知识文件目录 -->
                            <StackPanel Spacing="{StaticResource SmallSpacing}">
                                <TextBlock Text="知识文件目录"
                                           FontSize="{StaticResource LabelFontSize}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBox Grid.Column="0"
                                             Text="{Binding UserSetting.KnowledgeFileDirectory}"
                                             Watermark="请选择知识库目录"
                                             IsReadOnly="True"/>
                                    <Button Grid.Column="1"
                                            Content="浏览"
                                            Command="{Binding SelectKnowledgeDirectoryCommand}"
                                            Background="{DynamicResource PrimaryBrush}"
                                            Foreground="White"
                                            Margin="{StaticResource SmallLeftMargin}"/>
                                </Grid>
                            </StackPanel>

                            <!-- 知识库向量化 -->
                            <StackPanel Spacing="{StaticResource SmallSpacing}">
                                <TextBlock Text="知识库向量化"
                                           FontSize="{StaticResource LabelFontSize}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                
                                <StackPanel Orientation="Horizontal" Spacing="{StaticResource DefaultSpacing}">
                                    <Button Content="向量化文档"
                                            Command="{Binding VectorizeDocumentsCommand}"
                                            Background="{DynamicResource SuccessBrush}"
                                            Foreground="White"
                                            IsEnabled="{Binding IsKnowledgeDirectoryValid}"/>
                                    <PathIcon Data="{StaticResource LoadingIcon}"
                                              Width="{StaticResource DefaultIconSize}"
                                              Height="{StaticResource DefaultIconSize}"
                                              Foreground="{DynamicResource PrimaryBrush}"
                                              IsVisible="{Binding IsVectorizing}"/>
                                </StackPanel>
                                
                                <!-- 向量化进度 -->
                                <StackPanel IsVisible="{Binding IsVectorizing}" Spacing="{StaticResource SmallSpacing}">
                                    <ProgressBar Value="{Binding VectorizingProgress}"
                                                 Maximum="100"
                                                 Height="{StaticResource ProgressBarHeight}"/>
                                    <TextBlock Text="{Binding VectorizingProgressText}"
                                               FontSize="{StaticResource BodyFontSize}"
                                               Foreground="{DynamicResource PrimaryBrush}"
                                               FontWeight="Medium"/>
                                </StackPanel>
                                
                                <TextBlock Text="将读取知识文件夹中的PDF、DOCX和Markdown文件并进行向量化存储"
                                           FontSize="{StaticResource SmallFontSize}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </controls:CardView>

                <!-- 市场分析师角色设置区域 -->
                <controls:CardView Header="市场分析师角色设置">
                    <StackPanel Spacing="{StaticResource LargeSpacing}">
                        <StackPanel Spacing="{StaticResource TinySpacing}">
                            <TextBlock Text="选择参与分析讨论的角色"
                                       FontSize="{StaticResource LabelFontSize}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBlock Text="注意：启用的角色越多，消耗的Token越多"
                                       FontSize="{StaticResource SmallFontSize}"
                                       Foreground="{DynamicResource ErrorBrush}"/>
                        </StackPanel>

                        <ItemsControl ItemsSource="{Binding AnalystRoles}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="2" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*" 
                                          RowDefinitions="Auto,Auto" 
                                          Margin="0,0,8,16">
                                        <CheckBox Grid.Row="0" Grid.Column="0" Grid.RowSpan="2"
                                                  IsChecked="{Binding IsEnabled}"
                                                  IsEnabled="{Binding !IsRequired}"
                                                  VerticalAlignment="Top"
                                                  Margin="{StaticResource SmallRightMargin}"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   FontSize="{StaticResource LabelFontSize}"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1"
                                                   Text="{Binding Description}"
                                                   FontSize="{StaticResource SmallFontSize}"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   Margin="{StaticResource TinyTopMargin}"
                                                   TextWrapping="Wrap"/>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </controls:CardView>

                <!-- 通知设置区域 -->
                <controls:CardView Header="通知设置">
                    <CheckBox IsChecked="{Binding UserSetting.Notification}"
                              Content="开启通知"/>
                </controls:CardView>

                <!-- 浏览器设置区域 -->
                <controls:CardView Header="浏览器设置">
                    <StackPanel Spacing="{StaticResource SmallSpacing}">
                        <TextBlock Text="浏览器路径"
                                   FontSize="{StaticResource LabelFontSize}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding UserSetting.BrowserPath}"
                                     Watermark="请选择浏览器路径（留空则自动检测）"
                                     IsReadOnly="True"/>
                            <Button Grid.Column="1"
                                    Content="浏览"
                                    Command="{Binding SelectBrowserPathCommand}"
                                    Background="{DynamicResource InfoBrush}"
                                    Foreground="White"
                                    Margin="{StaticResource SmallLeftMargin}"/>
                        </Grid>
                        <TextBlock Text="注意：如果留空，系统将自动使用默认浏览器"
                                   FontSize="{StaticResource SmallFontSize}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </controls:CardView>

                <!-- 日志设置区域 -->
                <controls:CardView Header="日志设置">
                    <StackPanel Spacing="{StaticResource SmallSpacing}">
                        <TextBlock Text="日志文件路径"
                                   FontSize="{StaticResource LabelFontSize}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding UserSetting.LogPath}"
                                     Watermark="请输入日志文件路径"/>
                            <Button Grid.Column="1"
                                    Content="浏览"
                                    Command="{Binding SelectLogPathCommand}"
                                    Background="{DynamicResource InfoBrush}"
                                    Foreground="White"
                                    Margin="{StaticResource SmallLeftMargin}"/>
                        </Grid>
                    </StackPanel>
                </controls:CardView>

                <!-- Web Search设置区域 -->
                <controls:CardView Header="Web Search设置">
                    <StackPanel Spacing="{StaticResource DefaultSpacing}">
                        <!-- 是否启用Web Search -->
                        <CheckBox IsChecked="{Binding UserSetting.EnableWebSearch}"
                                  Content="启用Web Search功能"/>

                        <StackPanel Spacing="{StaticResource DefaultSpacing}" 
                                    IsEnabled="{Binding UserSetting.EnableWebSearch}">
                            <Grid ColumnDefinitions="Auto,*">
                                <!-- 搜索平台选择 -->
                                <StackPanel Grid.Column="0" Spacing="{StaticResource SmallSpacing}">
                                    <TextBlock Text="搜索平台选择"
                                               FontSize="{StaticResource LabelFontSize}"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <ComboBox ItemsSource="{Binding WebSearchProviders}"
                                              SelectedItem="{Binding UserSetting.WebSearchProvider}"
                                              Width="{StaticResource SettingsComboBoxWidth}"/>
                                </StackPanel>
                                
                                <!-- API Key -->
                                <StackPanel Grid.Column="1" Spacing="{StaticResource SmallSpacing}" Margin="{StaticResource LeftMargin}">
                                    <TextBlock Text="Web Search API Key"
                                               FontSize="{StaticResource LabelFontSize}"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBox Text="{Binding UserSetting.WebSearchApiKey}"
                                             Watermark="请输入Web Search API Key"/>
                                </StackPanel>
                            </Grid>
                            
                            <TextBlock Text="注意：启用Web Search功能需要配置有效的API Key"
                                       FontSize="{StaticResource SmallFontSize}"
                                       Foreground="{DynamicResource ErrorBrush}"/>
                        </StackPanel>
                    </StackPanel>
                </controls:CardView>

                <!-- MCP服务器配置区域 -->
                <controls:CardView Header="MCP服务器配置">
                    <StackPanel Spacing="{StaticResource SmallSpacing}">
                        <TextBlock Text="配置MCP服务器，用于连接外部服务"
                                   FontSize="{StaticResource LabelFontSize}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <Button Content="MCP服务器配置"
                                Command="{Binding NavigateToMCPConfigCommand}"
                                Background="{DynamicResource InfoBrush}"
                                Foreground="White"
                                HorizontalAlignment="Left"/>
                    </StackPanel>
                </controls:CardView>
            </StackPanel>
        </ScrollViewer>

        <!-- 底部操作栏 -->
        <Border Grid.Row="1" 
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="{StaticResource TopBorderThickness}"
                Padding="{StaticResource FooterPadding}">
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Spacing="{StaticResource DefaultSpacing}">
                <Button Content="重置"
                        Command="{Binding ResetCommand}"
                        Background="{DynamicResource TextSecondaryBrush}"
                        Foreground="White"
                        MinWidth="{StaticResource MediumButtonMinWidth}"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"/>
                <Button Content="保存"
                        Command="{Binding SaveCommand}"
                        Background="{DynamicResource PrimaryButtonBrush}"
                        Foreground="White"
                        MinWidth="{StaticResource MediumButtonMinWidth}"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>