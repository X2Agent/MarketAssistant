name: Build and Release
# ä¼˜åŒ–åçš„å‘å¸ƒè„šæœ¬ - æé«˜æ„å»ºé€Ÿåº¦
permissions:
  contents: write

env:
  DOTNET_VERSION: "9.0.x"
  BUILD_CONFIGURATION: "Release"

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ - ä¿®å¤Windowsè·¯å¾„
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~\.nuget\packages
            ~\.nuget\global-packages
            ~\.nuget\tools
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # ç¼“å­˜MAUI workload - ä¿®å¤Windowsè·¯å¾„
      - name: Cache MAUI workload
        uses: actions/cache@v4
        with:
          path: |
            ~\.dotnet\tools
            ~\.dotnet\workloads
          key: ${{ runner.os }}-maui-workload-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-maui-workload-

      # å®‰è£…MAUI workload
      - name: Install MAUI workload
        run: dotnet workload install maui-windows

      # æ¢å¤ä¾èµ–
      - name: Restore dependencies
        run: dotnet restore MarketAssistant/MarketAssistant.WinUI/MarketAssistant.WinUI.csproj --runtime win-x64 --verbosity minimal

      # ä¼˜åŒ–æ„å»ºé…ç½®
      - name: Build Windows app
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          NUGET_XMLDOC_MODE: skip
        run: |
          dotnet publish MarketAssistant/MarketAssistant.WinUI/MarketAssistant.WinUI.csproj `
            -c ${{ env.BUILD_CONFIGURATION }} `
            -f net9.0-windows10.0.19041.0 `
            -r win-x64 `
            -p:Platform=x64 `
            -p:SelfContained=false `
            -p:PublishReadyToRun=false `
            -p:PublishTrimmed=false `
            -p:EnableCompressionInSingleFile=false `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            --verbosity minimal `
            --no-restore `
            -o ./publish/windows

      # ä¼˜åŒ–æ‰“åŒ…è¿‡ç¨‹
      - name: Create Windows package
        run: |
          # åˆ›å»ºå®‰è£…åŒ…ç›®å½•
          New-Item -ItemType Directory -Force -Path "./installer/windows"

          # å¤åˆ¶æ–‡ä»¶
          Copy-Item -Path "./publish/windows/*" -Destination "./installer/windows/" -Recurse

          # åˆ›å»ºå®‰è£…è„šæœ¬
          @'
          @echo off
          echo Installing MarketAssistant...
          if not exist "%ProgramFiles%\MarketAssistant" mkdir "%ProgramFiles%\MarketAssistant"
          xcopy /E /I /Y "%~dp0*" "%ProgramFiles%\MarketAssistant\"
          echo Installation completed!
          pause
          '@ | Out-File -FilePath "./installer/windows/install.bat" -Encoding ASCII

          # ä½¿ç”¨æ›´å¿«çš„å‹ç¼©æ–¹å¼
          Compress-Archive -Path "./installer/windows/*" -DestinationPath "./MarketAssistant-Windows-x64.zip" -CompressionLevel Optimal

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-${{ matrix.platform }}
          path: ./MarketAssistant-Windows-x64.zip
          retention-days: 7

  # å¹¶è¡Œæ„å»ºmacOSç‰ˆæœ¬
  build-macos:
    runs-on: macos-14

    strategy:
      matrix:
        platform: [x64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ä¼˜åŒ–ç¼“å­˜ - macOSè·¯å¾„
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.nuget/global-packages
            ~/.nuget/tools
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache MAUI workload
        uses: actions/cache@v4
        with:
          path: |
            ~/.dotnet/tools
            ~/.dotnet/workloads
          key: ${{ runner.os }}-maui-workload-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-maui-workload-

      - name: Install MAUI workload
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          NUGET_XMLDOC_MODE: skip
          EnableWindowsTargeting: false
        run: dotnet workload install maui-maccatalyst

      - name: Restore dependencies
        env:
          EnableWindowsTargeting: false
        run: dotnet restore MarketAssistant/MarketAssistant.Mac/MarketAssistant.Mac.csproj --runtime maccatalyst-x64 --verbosity minimal

      - name: Build macOS app
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          NUGET_XMLDOC_MODE: skip
          EnableWindowsTargeting: false
        run: |
          # æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
          echo "Building macOS app..."
          dotnet --info

          # æ‰§è¡Œæ„å»º
          dotnet publish MarketAssistant/MarketAssistant.Mac/MarketAssistant.Mac.csproj \
            -c ${{ env.BUILD_CONFIGURATION }} \
            -f net9.0-maccatalyst \
            -r maccatalyst-x64 \
            -p:CreatePackage=true \
            -p:EnableWindowsTargeting=false \
            -p:TargetPlatformIdentifier=maccatalyst \
            -p:SupportedOSPlatformVersion=15.0 \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            -p:SelfContained=false \
            --no-restore \
            --verbosity normal \
            -o ./publish/macos
            
          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo "Build completed. Contents of publish directory:"
          ls -la ./publish/macos

      - name: Create macOS package
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ .app æ–‡ä»¶
          APP_PATH=$(find ./publish/macos -name "*.app" -type d | head -1)

          if [ -n "$APP_PATH" ]; then
            echo "Found app at: $APP_PATH"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºDMGå†…å®¹
            mkdir -p ./dmg-contents
            cp -R "$APP_PATH" ./dmg-contents/
            
            # åˆ›å»ºDMG
            hdiutil create -volname "MarketAssistant" \
              -srcfolder ./dmg-contents \
              -ov -format UDZO \
              ./MarketAssistant-macOS.dmg
          else
            echo "No .app bundle found, creating zip instead"
            cd ./publish/macos
            zip -r ../../MarketAssistant-macOS.zip . -q
            cd ../..
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-${{ matrix.platform }}
          path: |
            ./MarketAssistant-macOS.dmg
            ./MarketAssistant-macOS.zip
          if-no-files-found: ignore
          retention-days: 7

  # å‘å¸ƒæ­¥éª¤ - å…è®¸éƒ¨åˆ†å¹³å°å¤±è´¥
  release:
    # ä¿®æ”¹ä¾èµ–å…³ç³»ï¼šæ€»æ˜¯è¿è¡Œï¼Œä½†éœ€è¦è‡³å°‘ä¸€ä¸ªæ„å»ºjobå®Œæˆ
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: (success() || failure()) && (github.event_name == 'release' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release-x64
          path: ./windows-artifacts
        continue-on-error: true

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-release-x64
          path: ./macos-artifacts
        continue-on-error: true

      - name: Debug - List all artifacts
        run: |
          echo "=== Debugging artifact download ==="
          echo "Current directory contents:"
          ls -la ./

          echo "Windows artifacts directory:"
          if [ -d "./windows-artifacts" ]; then
            ls -la ./windows-artifacts/
          else
            echo "Windows artifacts directory not found"
          fi

          echo "macOS artifacts directory:"
          if [ -d "./macos-artifacts" ]; then
            ls -la ./macos-artifacts/
          else
            echo "macOS artifacts directory not found"
          fi

      - name: Prepare release assets
        run: |
          echo "Preparing release assets..."

          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ./release-assets

          # æ£€æŸ¥Windowsæ„å»ºç»“æœ
          WINDOWS_SUCCESS=false
          if [ -d "./windows-artifacts" ] && [ -f "./windows-artifacts/MarketAssistant-Windows-x64.zip" ]; then
            cp ./windows-artifacts/MarketAssistant-Windows-x64.zip ./release-assets/
            echo "âœ… Windows artifact prepared"
            WINDOWS_SUCCESS=true
          else
            echo "âŒ Windows build artifact not found"
          fi

          # æ£€æŸ¥macOSæ„å»ºç»“æœ
          MACOS_SUCCESS=false
          if [ -d "./macos-artifacts" ]; then
            if [ -f "./macos-artifacts/MarketAssistant-macOS.dmg" ]; then
              cp ./macos-artifacts/MarketAssistant-macOS.dmg ./release-assets/
              echo "âœ… macOS DMG prepared"
              MACOS_SUCCESS=true
            fi
            if [ -f "./macos-artifacts/MarketAssistant-macOS.zip" ]; then
              cp ./macos-artifacts/MarketAssistant-macOS.zip ./release-assets/
              echo "âœ… macOS ZIP prepared"
              MACOS_SUCCESS=true
            fi
          fi

          if [ "$MACOS_SUCCESS" = false ]; then
            echo "âš ï¸ macOS build artifact not found - will proceed with available platforms"
          fi

          # è‡³å°‘éœ€è¦ä¸€ä¸ªå¹³å°æˆåŠŸ
          if [ "$WINDOWS_SUCCESS" = false ] && [ "$MACOS_SUCCESS" = false ]; then
            echo "âŒ No build artifacts found - release cannot proceed"
            exit 1
          fi

          echo "ğŸ“¦ Release will proceed with available platforms:"
          [ "$WINDOWS_SUCCESS" = true ] && echo "  - Windows âœ…"
          [ "$MACOS_SUCCESS" = true ] && echo "  - macOS âœ…"

          # åˆ—å‡ºå®é™…å¯ç”¨çš„æ–‡ä»¶
          echo "ğŸ“‹ Available release files:"
          ls -la ./release-assets/

      - name: Upload release assets
        run: |
          echo "=== Preparing files for release ==="

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -d "./release-assets" ]; then
            echo "Release assets directory contents:"
            ls -la ./release-assets/
            
            # æ”¶é›†æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ•°ç»„
            FILES=""
            for file in ./release-assets/*; do
              if [ -f "$file" ]; then
                FILES="$FILES$file\n"
                echo "Found file: $file"
              fi
            done
            
            if [ -n "$FILES" ]; then
              echo "Files ready for upload:"
              echo -e "$FILES"
            else
              echo "No files found in release-assets directory"
              exit 1
            fi
          else
            echo "Release assets directory not found"
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release-assets/*
          fail_on_unmatched_files: false
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          prerelease: false
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', github.run_number) || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && format('Release v{0}', github.run_number) || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
