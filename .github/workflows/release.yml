name: Build and Release
# Avalonia è·¨å¹³å°æž„å»ºå‘å¸ƒæµç¨‹

permissions:
  contents: write

env:
  DOTNET_VERSION: "9.0.x"
  BUILD_CONFIGURATION: "Release"
  PROJECT_PATH: "src/MarketAssistant.csproj"

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~\.nuget\packages
            ~\.nuget\global-packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Build Windows x64
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c ${{ env.BUILD_CONFIGURATION }} `
            -r win-x64 `
            --self-contained `
            -p:PublishReadyToRun=true `
            -p:DebugType=None `
            -p:DebugSymbols=false `
            --no-restore `
            -o ./publish/windows-x64

      - name: Create Windows package
        run: |
          # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
          Remove-Item -Path "./publish/windows-x64/*.pdb" -ErrorAction SilentlyContinue
          Remove-Item -Path "./publish/windows-x64/*.xml" -ErrorAction SilentlyContinue
          
          # åˆ›å»ºZIPåŒ…
          Compress-Archive -Path "./publish/windows-x64/*" -DestinationPath "./MarketAssistant-Windows-x64.zip" -CompressionLevel Optimal

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-x64
          path: ./MarketAssistant-Windows-x64.zip
          retention-days: 7

  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.nuget/global-packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Build macOS x64
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c ${{ env.BUILD_CONFIGURATION }} \
            -r osx-x64 \
            --self-contained \
            -p:PublishReadyToRun=true \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            --no-restore \
            -o ./publish/macos-x64

      - name: Create macOS packages
        run: |
          # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
          find ./publish/macos-x64 -name "*.pdb" -delete
          find ./publish/macos-x64 -name "*.xml" -delete
          
          # åˆ›å»º ZIP åŒ…
          cd ./publish/macos-x64
          zip -r ../../MarketAssistant-macOS-x64.zip . -q
          cd ../..
          
          # åˆ›å»º .app bundle ç»“æž„
          APP_NAME="MarketAssistant"
          APP_BUNDLE="./dmg-contents/${APP_NAME}.app"
          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp -R ./publish/macos-x64/* "${APP_BUNDLE}/Contents/MacOS/"
          
          # åˆ›å»º Info.plist
          cat > "${APP_BUNDLE}/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>MarketAssistant</string>
              <key>CFBundleIdentifier</key>
              <string>com.marketassistant.app</string>
              <key>CFBundleName</key>
              <string>MarketAssistant</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x "${APP_BUNDLE}/Contents/MacOS/MarketAssistant"
          
          # åˆ›å»º DMG
          hdiutil create -volname "${APP_NAME}" \
            -srcfolder ./dmg-contents \
            -ov -format UDZO \
            ./MarketAssistant-macOS.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-x64
          path: |
            ./MarketAssistant-macOS-x64.zip
            ./MarketAssistant-macOS.dmg
          retention-days: 7

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.nuget/global-packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Build Linux x64
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c ${{ env.BUILD_CONFIGURATION }} \
            -r linux-x64 \
            --self-contained \
            -p:PublishReadyToRun=true \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            --no-restore \
            -o ./publish/linux-x64

      - name: Create Linux package
        run: |
          # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
          find ./publish/linux-x64 -name "*.pdb" -delete
          find ./publish/linux-x64 -name "*.xml" -delete
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x ./publish/linux-x64/MarketAssistant
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > ./publish/linux-x64/run.sh << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          cd "$SCRIPT_DIR"
          ./MarketAssistant "$@"
          EOF
          
          chmod +x ./publish/linux-x64/run.sh
          
          # åˆ›å»º ZIP åŒ…
          cd ./publish/linux-x64
          zip -r ../../MarketAssistant-Linux-x64.zip . -q
          cd ../..

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-x64
          path: ./MarketAssistant-Linux-x64.zip
          retention-days: 7

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: success() || failure()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p ./release-assets
          
          # æ”¶é›†æ‰€æœ‰æž„å»ºäº§ç‰©
          find ./artifacts -type f \( -name "*.zip" -o -name "*.dmg" \) -exec cp {} ./release-assets/ \;
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "ðŸ“¦ Release assets:"
          ls -lh ./release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release-assets/*
          fail_on_unmatched_files: false
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          prerelease: false
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', github.run_number) || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && format('Release v{0}', github.run_number) || github.ref_name }}
          body: |
            ## MarketAssistant Release
            
            åŸºäºŽ Avalonia UI çš„è·¨å¹³å°è‚¡ç¥¨åˆ†æžå·¥å…·
            
            ### å¹³å°æ”¯æŒ
            - âœ… Windows (x64)
            - âœ… macOS (x64)
            - âœ… Linux (x64)
            
            ### ä¸‹è½½è¯´æ˜Ž
            - **Windows**: ä¸‹è½½ `MarketAssistant-Windows-x64.zip`ï¼Œè§£åŽ‹åŽè¿è¡Œ `MarketAssistant.exe`
            - **macOS**: ä¸‹è½½ `MarketAssistant-macOS.dmg` æˆ– `MarketAssistant-macOS-x64.zip`
            - **Linux**: ä¸‹è½½ `MarketAssistant-Linux-x64.zip`ï¼Œè§£åŽ‹åŽè¿è¡Œ `./run.sh` æˆ– `./MarketAssistant`
            
            ### ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 (x64)
            - macOS 10.15+ (Catalina or later)
            - Linux with X11 or Wayland
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
